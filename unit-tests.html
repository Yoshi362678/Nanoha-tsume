<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ãªã®ã¯è©°ã‚ã‚¨ãƒ³ã‚¸ãƒ³ - å˜ä½“ãƒ†ã‚¹ãƒˆ</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .test-suite {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-group {
            margin: 20px 0;
            padding: 15px;
            border-left: 3px solid #2196F3;
            background: #f9f9f9;
        }
        .test-case {
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-radius: 5px;
        }
        .pass {
            color: #4CAF50;
            font-weight: bold;
        }
        .fail {
            color: #f44336;
            font-weight: bold;
        }
        .test-result {
            margin-left: 20px;
            padding: 5px;
            font-family: monospace;
            font-size: 12px;
        }
        button {
            padding: 10px 20px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background: #1976D2;
        }
        .summary {
            padding: 15px;
            background: #e3f2fd;
            border-radius: 5px;
            margin: 20px 0;
            font-size: 18px;
        }
        .error-detail {
            background: #ffebee;
            color: #c62828;
            padding: 10px;
            border-radius: 5px;
            margin: 5px 0;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª ãªã®ã¯è©°ã‚ã‚¨ãƒ³ã‚¸ãƒ³ - å˜ä½“ãƒ†ã‚¹ãƒˆ</h1>
    
    <div class="test-suite">
        <h2>ãƒ†ã‚¹ãƒˆåˆ¶å¾¡</h2>
        <button onclick="runAllTests()">å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
        <button onclick="runCoreTests()">ã‚³ã‚¢æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ</button>
        <button onclick="runValidationTests()">å¦¥å½“æ€§æ¤œè¨¼ãƒ†ã‚¹ãƒˆ</button>
        <button onclick="runPerformanceTests()">ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ</button>
        <button onclick="clearResults()">çµæœã‚¯ãƒªã‚¢</button>
    </div>
    
    <div id="testSummary" class="summary" style="display: none;"></div>
    <div id="testResults"></div>

    <script>
        // ãƒ†ã‚¹ãƒˆãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯
        class TestRunner {
            constructor() {
                this.results = [];
                this.currentGroup = '';
            }

            assert(condition, message) {
                if (!condition) {
                    throw new Error(message || 'Assertion failed');
                }
            }

            assertEquals(actual, expected, message) {
                if (actual !== expected) {
                    throw new Error(message || `Expected ${expected}, got ${actual}`);
                }
            }

            assertArrayEquals(actual, expected, message) {
                if (JSON.stringify(actual) !== JSON.stringify(expected)) {
                    throw new Error(message || `Arrays not equal: ${JSON.stringify(actual)} !== ${JSON.stringify(expected)}`);
                }
            }

            runTest(name, testFunc) {
                const startTime = performance.now();
                let result = {
                    name: name,
                    group: this.currentGroup,
                    passed: false,
                    error: null,
                    time: 0
                };

                try {
                    testFunc();
                    result.passed = true;
                } catch (error) {
                    result.error = error.message;
                }

                result.time = performance.now() - startTime;
                this.results.push(result);
                return result;
            }

            setGroup(name) {
                this.currentGroup = name;
            }

            getSummary() {
                const total = this.results.length;
                const passed = this.results.filter(r => r.passed).length;
                const failed = total - passed;
                const totalTime = this.results.reduce((sum, r) => sum + r.time, 0);
                
                return {
                    total,
                    passed,
                    failed,
                    totalTime,
                    passRate: total > 0 ? (passed / total * 100).toFixed(1) : 0
                };
            }

            clear() {
                this.results = [];
                this.currentGroup = '';
            }
        }

        const runner = new TestRunner();

        // ã‚³ã‚¢æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
        function runCoreTests() {
            runner.setGroup('åº§æ¨™å¤‰æ›ãƒ†ã‚¹ãƒˆ');
            
            runner.runTest('humanToInternal - æ­£å¸¸ç³»', () => {
                runner.assertArrayEquals(humanToInternal('ï¼•ä¸€'), [0, 4]);
                runner.assertArrayEquals(humanToInternal('ï¼‘ä¹'), [8, 8]);
                runner.assertArrayEquals(humanToInternal('ï¼™äº”'), [4, 0]);
            });

            runner.runTest('humanToInternal - ç•°å¸¸ç³»', () => {
                runner.assert(humanToInternal('') === null);
                runner.assert(humanToInternal('ã‚ã„') === null);
                runner.assert(humanToInternal('10ä¸€') === null);
            });

            runner.runTest('internalToHuman - æ­£å¸¸ç³»', () => {
                runner.assertEquals(internalToHuman(0, 4), 'ï¼•ä¸€');
                runner.assertEquals(internalToHuman(8, 8), 'ï¼‘ä¹');
                runner.assertEquals(internalToHuman(4, 0), 'ï¼™äº”');
            });

            runner.setGroup('é§’ã®å‹•ããƒ†ã‚¹ãƒˆ');

            runner.runTest('ç›¤å†…åˆ¤å®š', () => {
                // ä»®ã®ã‚¨ãƒ³ã‚¸ãƒ³ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ
                const testEngine = {
                    isInBoard: (row, col) => row >= 0 && row < 9 && col >= 0 && col < 9
                };
                
                runner.assert(testEngine.isInBoard(0, 0) === true);
                runner.assert(testEngine.isInBoard(8, 8) === true);
                runner.assert(testEngine.isInBoard(-1, 0) === false);
                runner.assert(testEngine.isInBoard(9, 0) === false);
                runner.assert(testEngine.isInBoard(0, -1) === false);
                runner.assert(testEngine.isInBoard(0, 9) === false);
            });

            runner.runTest('æˆã‚Šåˆ¤å®š', () => {
                // ä»®ã®canPromoteé–¢æ•°
                const canPromote = (piece, fromRow, toRow, side) => {
                    if (piece === 'é‡‘' || piece === 'ç‰' || 
                        piece === 'ã¨' || piece === 'æ' || piece === 'åœ­' || 
                        piece === 'å…¨' || piece === 'é¦¬' || piece === 'é¾') {
                        return false;
                    }
                    
                    if (side === 'sente') {
                        return fromRow <= 2 || toRow <= 2;
                    } else {
                        return fromRow >= 6 || toRow >= 6;
                    }
                };

                runner.assert(canPromote('æ­©', 2, 1, 'sente') === true);
                runner.assert(canPromote('æ­©', 3, 2, 'sente') === true);
                runner.assert(canPromote('æ­©', 4, 3, 'sente') === false);
                runner.assert(canPromote('é‡‘', 2, 1, 'sente') === false);
                runner.assert(canPromote('æ­©', 6, 7, 'gote') === true);
            });

            displayResults();
        }

        // å¦¥å½“æ€§æ¤œè¨¼ãƒ†ã‚¹ãƒˆ
        function runValidationTests() {
            runner.setGroup('ç›¤é¢å¦¥å½“æ€§ãƒ†ã‚¹ãƒˆ');

            runner.runTest('äºŒæ­©æ¤œå‡º', () => {
                const board = Array(9).fill(null).map(() => Array(9).fill(null));
                board[2][0] = { piece: 'æ­©', side: 'sente' };
                board[4][0] = { piece: 'æ­©', side: 'sente' };
                
                // äºŒæ­©ãŒã‚ã‚‹ã¯ãš
                let hasDuplicate = false;
                const pawnColumns = new Set();
                for (let row = 0; row < 9; row++) {
                    if (board[row][0] && board[row][0].piece === 'æ­©' && board[row][0].side === 'sente') {
                        if (pawnColumns.has(0)) {
                            hasDuplicate = true;
                            break;
                        }
                        pawnColumns.add(0);
                    }
                }
                runner.assert(hasDuplicate === true, 'äºŒæ­©ãŒæ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ');
            });

            runner.runTest('è¡Œãæ‰€ã®ãªã„é§’æ¤œå‡º', () => {
                // å…ˆæ‰‹ã®æ­©ãŒæœ€ä¸Šæ®µ
                runner.assert((() => {
                    const row = 0;
                    const piece = 'æ­©';
                    const side = 'sente';
                    return (piece === 'æ­©' || piece === 'é¦™') && row === 0;
                })() === true);

                // å¾Œæ‰‹ã®é¦™ãŒæœ€ä¸‹æ®µ
                runner.assert((() => {
                    const row = 8;
                    const piece = 'é¦™';
                    const side = 'gote';
                    return (piece === 'æ­©' || piece === 'é¦™') && row === 8;
                })() === true);
            });

            runner.runTest('é§’æ•°ä¸Šé™ãƒã‚§ãƒƒã‚¯', () => {
                const maxPieces = {
                    'é£›': 2, 'è§’': 2, 'é‡‘': 4, 'éŠ€': 4,
                    'æ¡‚': 4, 'é¦™': 4, 'æ­©': 18
                };

                // é£›è»Š3æšã¯ç„¡åŠ¹
                runner.assert(3 > maxPieces['é£›'], 'é£›è»Šã®æ•°ãŒä¸Šé™ã‚’è¶…ãˆã¦ã„ã¾ã™');
                
                // æ­©19æšã¯ç„¡åŠ¹
                runner.assert(19 > maxPieces['æ­©'], 'æ­©ã®æ•°ãŒä¸Šé™ã‚’è¶…ãˆã¦ã„ã¾ã™');
            });

            displayResults();
        }

        // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ
        function runPerformanceTests() {
            runner.setGroup('ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ');

            runner.runTest('ãƒãƒƒã‚·ãƒ¥ãƒ†ãƒ¼ãƒ–ãƒ«æ€§èƒ½', () => {
                const hashTable = new Map();
                const iterations = 10000;
                
                const startTime = performance.now();
                for (let i = 0; i < iterations; i++) {
                    hashTable.set(`key${i}`, { value: i });
                }
                for (let i = 0; i < iterations; i++) {
                    hashTable.get(`key${i}`);
                }
                const elapsed = performance.now() - startTime;
                
                runner.assert(elapsed < 100, `ãƒãƒƒã‚·ãƒ¥ãƒ†ãƒ¼ãƒ–ãƒ«æ“ä½œãŒé…ã™ãã¾ã™: ${elapsed}ms`);
            });

            runner.runTest('æ‰‹ã®ç”Ÿæˆé€Ÿåº¦', () => {
                // ç°¡æ˜“çš„ãªæ‰‹ç”Ÿæˆãƒ†ã‚¹ãƒˆ
                const moves = [];
                const startTime = performance.now();
                
                for (let from = 0; from < 81; from++) {
                    for (let to = 0; to < 81; to++) {
                        if (from !== to) {
                            moves.push({ from, to });
                        }
                    }
                }
                
                const elapsed = performance.now() - startTime;
                runner.assert(elapsed < 50, `æ‰‹ç”ŸæˆãŒé…ã™ãã¾ã™: ${elapsed}ms`);
                runner.assert(moves.length === 81 * 80, `ç”Ÿæˆã•ã‚ŒãŸæ‰‹æ•°ãŒä¸æ­£: ${moves.length}`);
            });

            runner.runTest('ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ãƒã‚§ãƒƒã‚¯', () => {
                if (performance.memory) {
                    const usedMemory = performance.memory.usedJSHeapSize / 1024 / 1024;
                    runner.assert(usedMemory < 100, `ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ãŒå¤šã™ãã¾ã™: ${usedMemory.toFixed(2)}MB`);
                } else {
                    // performance.memoryãŒä½¿ãˆãªã„ç’°å¢ƒã§ã¯ã‚¹ã‚­ãƒƒãƒ—
                    runner.assert(true, 'ãƒ¡ãƒ¢ãƒªæ¸¬å®šã¯ã“ã®ç’°å¢ƒã§ã¯åˆ©ç”¨ã§ãã¾ã›ã‚“');
                }
            });

            displayResults();
        }

        // å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        function runAllTests() {
            runner.clear();
            runCoreTests();
            runValidationTests();
            runPerformanceTests();
        }

        // çµæœè¡¨ç¤º
        function displayResults() {
            const resultsDiv = document.getElementById('testResults');
            const summaryDiv = document.getElementById('testSummary');
            
            // ã‚°ãƒ«ãƒ¼ãƒ—ã”ã¨ã«çµæœã‚’æ•´ç†
            const groupedResults = {};
            runner.results.forEach(result => {
                if (!groupedResults[result.group]) {
                    groupedResults[result.group] = [];
                }
                groupedResults[result.group].push(result);
            });

            // HTMLç”Ÿæˆ
            let html = '';
            for (const [group, results] of Object.entries(groupedResults)) {
                html += `<div class="test-group">`;
                html += `<h3>${group}</h3>`;
                
                results.forEach(result => {
                    const statusClass = result.passed ? 'pass' : 'fail';
                    const statusText = result.passed ? 'âœ… PASS' : 'âŒ FAIL';
                    
                    html += `<div class="test-case">`;
                    html += `<span class="${statusClass}">${statusText}</span> `;
                    html += `${result.name} `;
                    html += `<span style="color: #666;">(${result.time.toFixed(2)}ms)</span>`;
                    
                    if (!result.passed && result.error) {
                        html += `<div class="error-detail">${result.error}</div>`;
                    }
                    
                    html += `</div>`;
                });
                
                html += `</div>`;
            }
            
            resultsDiv.innerHTML = html;

            // ã‚µãƒãƒªãƒ¼è¡¨ç¤º
            const summary = runner.getSummary();
            summaryDiv.style.display = 'block';
            summaryDiv.innerHTML = `
                <strong>ãƒ†ã‚¹ãƒˆçµæœã‚µãƒãƒªãƒ¼</strong><br>
                ç·ãƒ†ã‚¹ãƒˆæ•°: ${summary.total}<br>
                æˆåŠŸ: <span class="pass">${summary.passed}</span><br>
                å¤±æ•—: <span class="fail">${summary.failed}</span><br>
                æˆåŠŸç‡: ${summary.passRate}%<br>
                å®Ÿè¡Œæ™‚é–“: ${summary.totalTime.toFixed(2)}ms
            `;
        }

        // çµæœã‚¯ãƒªã‚¢
        function clearResults() {
            runner.clear();
            document.getElementById('testResults').innerHTML = '';
            document.getElementById('testSummary').style.display = 'none';
        }

        // åº§æ¨™å¤‰æ›é–¢æ•°ï¼ˆãƒ¡ã‚¤ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰è¤‡è£½ï¼‰
        const SUJI_MAP = {'ï¼™': 0, 'ï¼˜': 1, 'ï¼—': 2, 'ï¼–': 3, 'ï¼•': 4, 'ï¼”': 5, 'ï¼“': 6, 'ï¼’': 7, 'ï¼‘': 8};
        const DAN_MAP = {'ä¸€': 0, 'äºŒ': 1, 'ä¸‰': 2, 'å››': 3, 'äº”': 4, 'å…­': 5, 'ä¸ƒ': 6, 'å…«': 7, 'ä¹': 8};
        const SUJI_STR = ['ï¼™', 'ï¼˜', 'ï¼—', 'ï¼–', 'ï¼•', 'ï¼”', 'ï¼“', 'ï¼’', 'ï¼‘'];
        const DAN_STR = ['ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­', 'ä¸ƒ', 'å…«', 'ä¹'];

        function humanToInternal(humanPos) {
            if (!humanPos || humanPos.length !== 2) return null;
            const suji = SUJI_MAP[humanPos[0]];
            const dan = DAN_MAP[humanPos[1]];
            if (suji === undefined || dan === undefined) return null;
            return [dan, suji];
        }

        function internalToHuman(row, col) {
            return SUJI_STR[col] + DAN_STR[row];
        }
    </script>
</body>
</html>