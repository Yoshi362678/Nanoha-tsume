<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ë©∞Â∞ÜÊ£ã„Ç®„É≥„Ç∏„É≥Ôºà„Å™„ÅÆ„ÅØË©∞„ÇÅ„Ç¢„É´„Ç¥„É™„Ç∫„É†Ôºâ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 30px;
            max-width: 1200px;
            width: 100%;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2em;
        }

        .main-content {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .board-section {
            flex: 1;
            min-width: 400px;
        }

        .board-container {
            position: relative;
            background: #f5deb3;
            border: 3px solid #8b4513;
            border-radius: 5px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .coordinates {
            position: absolute;
            font-weight: bold;
            color: #8b4513;
            font-size: 14px;
        }

        .coord-top {
            top: 5px;
            left: 50%;
            transform: translateX(-50%);
        }

        .coord-right {
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
        }

        #board {
            display: grid;
            grid-template-columns: repeat(9, 50px);
            grid-template-rows: repeat(9, 50px);
            gap: 1px;
            background: #8b4513;
            border: 2px solid #654321;
        }

        .cell {
            background: #faebd7;
            border: 1px solid #d2691e;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            transition: all 0.3s ease;
        }

        .cell:hover {
            background: #ffe4b5;
            transform: scale(1.05);
        }

        .cell.selected {
            background: #98fb98;
            box-shadow: inset 0 0 10px rgba(0, 255, 0, 0.5);
        }

        .cell.possible-move {
            background: #87ceeb;
            box-shadow: inset 0 0 10px rgba(0, 100, 255, 0.3);
        }

        .piece {
            font-size: 28px;
            font-weight: bold;
            user-select: none;
            transition: transform 0.2s ease;
        }

        .piece:hover {
            transform: scale(1.1);
        }

        .piece.sente {
            color: #000;
        }

        .piece.gote {
            color: #dc143c;
            transform: rotate(180deg);
        }

        .controls {
            flex: 1;
            min-width: 350px;
        }

        .control-section {
            background: #f9f9f9;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .control-section h2 {
            color: #555;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .piece-selector {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .piece-btn {
            padding: 10px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.3s ease;
        }

        .piece-btn:hover {
            background: #f0f0f0;
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
        }

        .piece-btn.selected {
            background: #4CAF50;
            color: white;
            border-color: #45a049;
        }

        .side-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .side-btn {
            flex: 1;
            padding: 10px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .side-btn.selected {
            background: #2196F3;
            color: white;
            border-color: #1976D2;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            flex: 1;
            min-width: 120px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #fc466b 0%, #3f5efb 100%);
            color: white;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        .status {
            margin-top: 20px;
            padding: 15px;
            background: #e8f5e9;
            border-left: 4px solid #4CAF50;
            border-radius: 5px;
            font-weight: bold;
        }

        .status.error {
            background: #ffebee;
            border-left-color: #f44336;
        }

        .status.success {
            background: #e8f5e9;
            border-left-color: #4CAF50;
        }

        .status.processing {
            background: #e3f2fd;
            border-left-color: #2196F3;
        }

        .move-list {
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-top: 10px;
        }

        .move-item {
            padding: 5px;
            margin: 2px 0;
            background: #f5f5f5;
            border-radius: 3px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .move-item:hover {
            background: #e0e0e0;
        }

        .stats {
            margin-top: 10px;
            font-size: 0.9em;
            color: #666;
        }

        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            #board {
                grid-template-columns: repeat(9, 40px);
                grid-template-rows: repeat(9, 40px);
            }
            
            .piece {
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ Ë©∞Â∞ÜÊ£ã„Ç®„É≥„Ç∏„É≥Ôºà„Å™„ÅÆ„ÅØË©∞„ÇÅ„Ç¢„É´„Ç¥„É™„Ç∫„É†Ôºâ</h1>
        
        <div class="main-content">
            <div class="board-section">
                <div class="board-container">
                    <div class="coordinates coord-top">‚ñºÂÖàÊâã</div>
                    <div class="coordinates coord-right">9 8 7 6 5 4 3 2 1</div>
                    <div id="board"></div>
                </div>
            </div>
            
            <div class="controls">
                <div class="control-section">
                    <h2>üìã ÈßíÈÖçÁΩÆ„É¢„Éº„Éâ</h2>
                    
                    <div class="side-selector">
                        <button class="side-btn selected" data-side="sente">‚òó ÂÖàÊâãÔºàÊîªÊñπÔºâ</button>
                        <button class="side-btn" data-side="gote">‚òñ ÂæåÊâãÔºàÁéâÊñπÔºâ</button>
                    </div>
                    
                    <div class="piece-selector">
                        <button class="piece-btn" data-piece="Áéâ">Áéâ</button>
                        <button class="piece-btn" data-piece="È£õ">È£õ</button>
                        <button class="piece-btn" data-piece="Ëßí">Ëßí</button>
                        <button class="piece-btn" data-piece="Èáë">Èáë</button>
                        <button class="piece-btn" data-piece="ÈäÄ">ÈäÄ</button>
                        <button class="piece-btn" data-piece="Ê°Ç">Ê°Ç</button>
                        <button class="piece-btn" data-piece="È¶ô">È¶ô</button>
                        <button class="piece-btn" data-piece="Ê≠©">Ê≠©</button>
                        <button class="piece-btn" data-piece="Èæç">Èæç</button>
                        <button class="piece-btn" data-piece="È¶¨">È¶¨</button>
                        <button class="piece-btn" data-piece="ÂÖ®">ÂÖ®</button>
                        <button class="piece-btn" data-piece="Âú≠">Âú≠</button>
                        <button class="piece-btn" data-piece="Êùè">Êùè</button>
                        <button class="piece-btn" data-piece="„Å®">„Å®</button>
                        <button class="piece-btn" data-piece="ÂâäÈô§">√ó</button>
                    </div>
                    
                    <div style="margin-top: 15px;">
                        <h3>ÊåÅ„Å°ÈßíÔºàÂÖàÊâã„ÅÆ„ÅøÔºâ</h3>
                        <div id="mochiGomaDisplay" style="padding: 10px; background: white; border-radius: 5px; min-height: 40px;">
                            <div>ÂÖàÊâã: <span id="senteMochi">„Å™„Åó</span></div>
                            <div style="color: #888; font-size: 0.9em;">‚ÄªË©∞Â∞ÜÊ£ã„Åß„ÅØÂÖàÊâã„ÅÆÊåÅÈßí‰ª•Â§ñ„ÅØÂÖ®„Å¶ÂæåÊâã„ÅåÊåÅ„Å£„Å¶„ÅÑ„Åæ„Åô</div>
                        </div>
                        <div style="margin-top: 10px;">
                            <label>ÂÖàÊâã„ÅÆÊåÅÈßí„Å´ËøΩÂä†: 
                                <select id="mochiPiece" style="padding: 5px;">
                                    <option value="">ÈÅ∏Êäû</option>
                                    <option value="È£õ">È£õ</option>
                                    <option value="Ëßí">Ëßí</option>
                                    <option value="Èáë">Èáë</option>
                                    <option value="ÈäÄ">ÈäÄ</option>
                                    <option value="Ê°Ç">Ê°Ç</option>
                                    <option value="È¶ô">È¶ô</option>
                                    <option value="Ê≠©">Ê≠©</option>
                                </select>
                            </label>
                            <button onclick="addMochiGoma()" style="padding: 5px 10px;">ËøΩÂä†</button>
                            <button onclick="clearSenteMochi()" style="padding: 5px 10px; background: #ff6b6b; color: white;">„ÇØ„É™„Ç¢</button>
                        </div>
                    </div>
                </div>
                
                <div class="control-section">
                    <h2>üéÆ Êìç‰Ωú</h2>
                    <div class="action-buttons">
                        <button class="btn-primary" onclick="solveTsume()">Ë©∞„Åø„ÇíËß£„Åè</button>
                        <button class="btn-secondary" onclick="clearBoard()">Áõ§Èù¢„ÇØ„É™„Ç¢</button>
                        <button class="btn-secondary" onclick="loadSampleProblem()">‰æãÈ°å„Çí„É©„É≥„ÉÄ„É†Ë™≠Ëæº</button>
                    </div>
                    <div style="margin-top: 10px;">
                        <select id="problemSelect" style="width: 100%; padding: 8px; margin-bottom: 5px;">
                            <option value="">‰æãÈ°å„ÇíÈÅ∏Êäû</option>
                            <option value="0">1ÊâãË©∞„ÇÅÔºàÂü∫Êú¨Ôºâ</option>
                            <option value="1">3ÊâãË©∞„ÇÅÔºàÊåÅÈßí‰ΩøÁî®Ôºâ</option>
                            <option value="2">3ÊâãË©∞„ÇÅÔºàÂêàÈßíÂïèÈ°åÔºâ</option>
                            <option value="3">‰∏çË©∞„ÅøÔºàÂêàÈßí„ÅßÈÄÉ„Çå„ÇãÔºâ</option>
                            <option value="4">1ÊâãË©∞„ÇÅÔºàÈ†≠ÈáëÔºâ</option>
                            <option value="5">3ÊâãË©∞„ÇÅÔºàÈ£õËªä„ÅÆÂà©„ÅçÔºâ</option>
                        </select>
                        <button onclick="loadSpecificProblem()" style="width: 100%; padding: 8px;">ÈÅ∏Êäû„Åó„Åü‰æãÈ°å„ÇíË™≠Ëæº</button>
                    </div>
                    <div style="margin-top: 15px;">
                        <h3>üíæ ÈÖçÁΩÆ„ÅÆ‰øùÂ≠ò„ÉªË™≠Ëæº</h3>
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <button onclick="savePosition()" style="flex: 1; padding: 8px;">ÁèæÂú®„ÅÆÈÖçÁΩÆ„Çí‰øùÂ≠ò</button>
                            <button onclick="showSavedPositions()" style="flex: 1; padding: 8px;">‰øùÂ≠ò„Åó„ÅüÈÖçÁΩÆ„ÇíË°®Á§∫</button>
                        </div>
                        <div id="savedPositions" style="display: none; margin-top: 10px;">
                            <select id="positionSelect" style="width: 100%; padding: 5px; margin-bottom: 10px;">
                                <option value="">‰øùÂ≠ò„Åó„ÅüÈÖçÁΩÆ„ÇíÈÅ∏Êäû</option>
                            </select>
                            <div style="display: flex; gap: 10px;">
                                <button onclick="loadPosition()" style="flex: 1; padding: 8px;">Ë™≠Ëæº</button>
                                <button onclick="deletePosition()" style="flex: 1; padding: 8px; background: #ff6b6b; color: white;">ÂâäÈô§</button>
                            </div>
                        </div>
                        <div style="margin-top: 10px;">
                            <h4>ÈÖçÁΩÆ„Ç≥„Éº„Éâ</h4>
                            <textarea id="positionCode" style="width: 100%; height: 60px; font-family: monospace; font-size: 12px;" placeholder="ÈÖçÁΩÆ„Ç≥„Éº„Éâ„Çí„Åì„Åì„Å´Ë≤º„Çä‰ªò„Åë„Å¶Ë™≠„ÅøËæº„ÇÄ„Åì„Å®„ÇÇ„Åß„Åç„Åæ„Åô"></textarea>
                            <div style="display: flex; gap: 10px; margin-top: 5px;">
                                <button onclick="exportPosition()" style="flex: 1; padding: 8px;">ÁèæÂú®„ÅÆÈÖçÁΩÆ„Çí„Ç≥„Éî„Éº</button>
                                <button onclick="importPosition()" style="flex: 1; padding: 8px;">„Ç≥„Éº„Éâ„Åã„ÇâË™≠Ëæº</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="control-section">
                    <h2>üìä Áä∂ÊÖã</h2>
                    <div id="status" class="status">Èßí„ÇíÈÖçÁΩÆ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºàÂ∫ßÊ®ô‰æãÔºöÔºï‰∏ÄÁéâÔºâ</div>
                    <div id="stats" class="stats"></div>
                    <div id="moveList" class="move-list" style="display: none;"></div>
                    <div style="margin-top: 10px;">
                        <label>
                            <input type="checkbox" id="debugMode" onchange="toggleDebugMode()">
                            „Éá„Éê„ÉÉ„Ç∞„É¢„Éº„Éâ
                        </label>
                    </div>
                    <div id="debugOutput" style="display: none; margin-top: 10px; padding: 10px; background: #f0f0f0; border-radius: 5px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Â∫ßÊ®ôÂ§âÊèõÔºà‰∫∫ÈñìË°®Ë®ò„ÇíÂü∫Ê∫ñ„Å´Ôºâ
        const SUJI_MAP = {'Ôºô': 0, 'Ôºò': 1, 'Ôºó': 2, 'Ôºñ': 3, 'Ôºï': 4, 'Ôºî': 5, 'Ôºì': 6, 'Ôºí': 7, 'Ôºë': 8};
        const DAN_MAP = {'‰∏Ä': 0, '‰∫å': 1, '‰∏â': 2, 'Âõõ': 3, '‰∫î': 4, 'ÂÖ≠': 5, '‰∏É': 6, 'ÂÖ´': 7, '‰πù': 8};
        const SUJI_STR = ['Ôºô', 'Ôºò', 'Ôºó', 'Ôºñ', 'Ôºï', 'Ôºî', 'Ôºì', 'Ôºí', 'Ôºë'];
        const DAN_STR = ['‰∏Ä', '‰∫å', '‰∏â', 'Âõõ', '‰∫î', 'ÂÖ≠', '‰∏É', 'ÂÖ´', '‰πù'];

        // ‰∫∫ÈñìË°®Ë®ò„Åã„ÇâÂÜÖÈÉ®Â∫ßÊ®ô„Å∏
        function humanToInternal(humanPos) {
            if (!humanPos || humanPos.length !== 2) return null;
            const suji = SUJI_MAP[humanPos[0]];
            const dan = DAN_MAP[humanPos[1]];
            if (suji === undefined || dan === undefined) return null;
            return [dan, suji];
        }

        // ÂÜÖÈÉ®Â∫ßÊ®ô„Åã„Çâ‰∫∫ÈñìË°®Ë®ò„Å∏
        function internalToHuman(row, col) {
            return SUJI_STR[col] + DAN_STR[row];
        }

        // Ë©∞Â∞ÜÊ£ã„Ç®„É≥„Ç∏„É≥Ôºà„Å™„ÅÆ„ÅØË©∞„ÇÅ„Ç¢„É´„Ç¥„É™„Ç∫„É†Ôºâ
        class TsumeShogi {
            constructor() {
                this.board = Array(9).fill(null).map(() => Array(9).fill(null));
                this.currentSide = 'sente';
                this.selectedPiece = null;
                this.solving = false;
                this.mochiGoma = { sente: {}, gote: {} };
                this.hashTable = new Map();
                this.nodeCount = 0;
                this.maxDepth = 25;  // Ê∑±„ÅïÂà∂Èôê„ÇíÂ¢ó„ÇÑ„Åó„Å¶Ê∑±„ÅÑË©∞„Åø„ÇÇËß£„Åë„Çã„Çà„ÅÜ„Å´
                this.debugMode = false;  // „Éá„Éê„ÉÉ„Ç∞„É¢„Éº„ÉâËøΩÂä†
                this.killerMoves = new Map();  // „Ç≠„É©„Éº„É†„Éº„ÉñÔºàËâØ„ÅÑÊâã„ÇíË®òÊÜ∂Ôºâ
                this.historyTable = new Map();  // „Éí„Çπ„Éà„É™„Éº„ÉÜ„Éº„Éñ„É´ÔºàÊâã„ÅÆË©ï‰æ°ÂÄ§Ôºâ
                this.init();
            }

            init() {
                this.createBoard();
                this.setupEventListeners();
                this.updateStatus('Èßí„ÇíÈÖçÁΩÆ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
            }

            createBoard() {
                const boardElement = document.getElementById('board');
                boardElement.innerHTML = '';
                
                for (let row = 0; row < 9; row++) {
                    for (let col = 0; col < 9; col++) {
                        const cell = document.createElement('div');
                        cell.className = 'cell';
                        cell.dataset.row = row;
                        cell.dataset.col = col;
                        cell.onclick = () => this.cellClick(row, col);
                        
                        const pos = internalToHuman(row, col);
                        cell.title = pos;
                        
                        boardElement.appendChild(cell);
                    }
                }
            }

            setupEventListeners() {
                document.querySelectorAll('.piece-btn').forEach(btn => {
                    btn.onclick = () => {
                        document.querySelectorAll('.piece-btn').forEach(b => b.classList.remove('selected'));
                        btn.classList.add('selected');
                        this.selectedPiece = btn.dataset.piece;
                    };
                });

                document.querySelectorAll('.side-btn').forEach(btn => {
                    btn.onclick = () => {
                        document.querySelectorAll('.side-btn').forEach(b => b.classList.remove('selected'));
                        btn.classList.add('selected');
                        this.currentSide = btn.dataset.side;
                    };
                });
            }

            cellClick(row, col) {
                if (this.solving) return;
                
                if (this.selectedPiece === 'ÂâäÈô§') {
                    this.board[row][col] = null;
                    this.updateBoard();
                    return;
                }
                
                if (this.selectedPiece) {
                    this.board[row][col] = {
                        piece: this.selectedPiece,
                        side: this.currentSide
                    };
                    this.updateBoard();
                }
            }

            updateBoard() {
                const cells = document.querySelectorAll('.cell');
                cells.forEach((cell, index) => {
                    const row = Math.floor(index / 9);
                    const col = index % 9;
                    const piece = this.board[row][col];
                    
                    if (piece) {
                        cell.innerHTML = `<span class="piece ${piece.side}">${piece.piece}</span>`;
                    } else {
                        cell.innerHTML = '';
                    }
                });
            }

            // Áõ§Èù¢„Çí„Éè„ÉÉ„Ç∑„É•Âåñ
            hashPosition() {
                let hash = '';
                for (let row = 0; row < 9; row++) {
                    for (let col = 0; col < 9; col++) {
                        const piece = this.board[row][col];
                        if (piece) {
                            hash += `${internalToHuman(row, col)}${piece.piece}${piece.side[0]}`;
                        }
                    }
                }
                for (const [piece, count] of Object.entries(this.mochiGoma.sente)) {
                    hash += `S${piece}${count}`;
                }
                return hash;
            }

            // „Å™„ÅÆ„ÅØË©∞„ÇÅ„Ç¢„É´„Ç¥„É™„Ç∫„É†„ÅÆ„É°„Ç§„É≥
            solveTsume() {
                if (this.debugMode) {
                    this.debugLog('=== Ë©∞Â∞ÜÊ£ãËß£ÊûêÈñãÂßã ===');
                    this.debugLog('ÁèæÂú®„ÅÆÁõ§Èù¢:');
                    this.debugBoard();
                }
                // Êó¢„Å´Êé¢Á¥¢‰∏≠„ÅÆÂ†¥Âêà„ÅØÂÆüË°å„Åó„Å™„ÅÑ
                if (this.solving) {
                    this.updateStatus('Êó¢„Å´Êé¢Á¥¢‰∏≠„Åß„Åô', 'error');
                    return;
                }
                
                this.solving = true;
                this.nodeCount = 0;
                this.hashTable.clear();
                this.killerMoves.clear();  // „Ç≠„É©„Éº„É†„Éº„Éñ„Çí„ÇØ„É™„Ç¢
                this.historyTable.clear();  // „Éí„Çπ„Éà„É™„Éº„ÉÜ„Éº„Éñ„É´„Çí„ÇØ„É™„Ç¢
                this.searchStartTime = Date.now();  // Êé¢Á¥¢ÈñãÂßãÊôÇÂàª
                this.maxSearchTime = 10000;  // ÊúÄÂ§ßÊé¢Á¥¢ÊôÇÈñìÔºà10ÁßíÔºöÂêàÈßí„ÇíÂê´„ÇÄ3ÊâãË©∞„ÇÅÂØæÂøúÔºâ
                this.maxNodes = 20000;  // ÊúÄÂ§ß„Éé„Éº„ÉâÊï∞Ôºà20000ÔºöÂêàÈßíÊé¢Á¥¢„Å´ÂøÖË¶ÅÔºâ
                this.repetitionTable = new Map();  // ÂçÉÊó•ÊâãÊ§úÂá∫Áî®
                this.updateStatus('Êé¢Á¥¢‰∏≠...', 'processing');
                
                // Áõ§Èù¢Â¶•ÂΩìÊÄß„ÉÅ„Çß„ÉÉ„ÇØ
                const validationResult = this.validateBoard();
                if (!validationResult.valid) {
                    this.updateStatus(validationResult.message, 'error');
                    this.solving = false;
                    return;
                }
                
                // ÂæåÊâãÁéâ„ÅÆ‰ΩçÁΩÆÁ¢∫Ë™ç
                let goteKingPos = null;
                for (let row = 0; row < 9; row++) {
                    for (let col = 0; col < 9; col++) {
                        const piece = this.board[row][col];
                        if (piece && piece.piece === 'Áéâ' && piece.side === 'gote') {
                            goteKingPos = internalToHuman(row, col);
                            break;
                        }
                    }
                }
                
                if (!goteKingPos) {
                    this.updateStatus('ÂæåÊâã„ÅÆÁéâ„ÇíÈÖçÁΩÆ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                    this.solving = false;
                    return;
                }

                // ÈùûÂêåÊúü„ÅßÂÆüË°å
                setTimeout(() => {
                    try {
                        const startTime = Date.now();
                        let solution = null;
                        
                        // ÂèçÂæ©Ê∑±Âåñ
                        for (let depth = 1; depth <= this.maxDepth; depth++) {
                            if (this.debugMode) {
                                this.debugLog(`\n=== Ê∑±„Åï ${depth} „ÅÆÊé¢Á¥¢ÈñãÂßã ===`);
                                this.debugLog(`ÁèæÂú®„ÅÆ„Éé„Éº„ÉâÊï∞: ${this.nodeCount}`);
                            }
                            
                            const result = this.search(depth, true);
                            if (result) {
                                solution = result;
                                break;
                            }
                            
                            // Âà∂Èôê„ÉÅ„Çß„ÉÉ„ÇØ
                            const elapsed = Date.now() - this.searchStartTime;
                            if (this.nodeCount > this.maxNodes || elapsed > this.maxSearchTime) {
                                if (this.debugMode) {
                                    this.debugLog(`Êé¢Á¥¢Âà∂Èôê„Å´Âà∞ÈÅî: „Éé„Éº„ÉâÊï∞=${this.nodeCount}, ÊôÇÈñì=${elapsed}ms`);
                                }
                                break;
                            }
                        }
                        
                        const elapsed = Date.now() - startTime;
                        
                        if (solution) {
                            this.updateStatus(`Ë©∞„Åø„Åæ„Åó„ÅüÔºÅ ${solution.length}ÊâãË©∞„ÇÅ`, 'success');
                            this.displayMoves(solution);
                        } else {
                            this.updateStatus('Ë©∞„Åø„Åæ„Åõ„Çì', 'error');
                        }
                        
                        document.getElementById('stats').innerHTML = 
                            `Êé¢Á¥¢„Éé„Éº„ÉâÊï∞: ${this.nodeCount.toLocaleString()} | ` +
                            `ÊôÇÈñì: ${(elapsed / 1000).toFixed(2)}Áßí`;
                        
                    } catch (error) {
                        console.error('„Ç®„É©„Éº:', error);
                        this.updateStatus('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü', 'error');
                    } finally {
                        this.solving = false;
                    }
                }, 10);
            }

            // „Åô„Åπ„Å¶„ÅÆË©∞„ÅøÂ§âÂåñ„ÇíÂèéÈõÜ
            collectAllMateVariations(depth) {
                const variations = [];
                
                // „Éè„ÉÉ„Ç∑„É•„ÉÜ„Éº„Éñ„É´„ÅåÂàùÊúüÂåñ„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅØÂàùÊúüÂåñ
                if (!this.hashTable) {
                    this.hashTable = new Map();
                }
                
                // ÂàùÊâã„ÅÆÁéãÊâã„Çí„Åô„Åπ„Å¶ÁîüÊàê
                const checks = this.generateChecks();
                
                for (const firstMove of checks) {
                    const backup1 = this.makeMove(firstMove);
                    
                    // „Åì„ÅÆÊâã„ÅßË©∞„ÇÄ„ÅãÁ¢∫Ë™ç
                    const result = this.search(depth - 1, false);
                    
                    if (result !== null && result !== undefined) {
                        // Ë©∞„Åø„Åå„ÅÇ„ÇãÂ†¥Âêà„ÄÅ„Åô„Åπ„Å¶„ÅÆÂ§âÂåñ„ÇíÂèéÈõÜ
                        const moveVariations = this.collectVariationsAfterMove(firstMove, depth - 1);
                        if (moveVariations.length > 0) {
                            variations.push({
                                firstMove: this.formatMove(firstMove),
                                variations: moveVariations
                            });
                        }
                    }
                    
                    this.unmakeMove(firstMove, backup1);
                }
                
                return variations;
            }
            
            // ÁâπÂÆö„ÅÆÊâã„ÅÆ„ÅÇ„Å®„ÅÆ„Åô„Åπ„Å¶„ÅÆÂ§âÂåñ„ÇíÂèéÈõÜ
            collectVariationsAfterMove(firstMove, remainingDepth) {
                const variations = [];
                
                if (!this.isCheck('gote')) {
                    return variations;
                }
                
                const evasions = this.generateEvasions();
                
                if (evasions.length === 0) {
                    // Âç≥Ë©∞„Åø
                    return [{
                        moves: [],
                        result: 'Ë©∞„Åø'
                    }];
                }
                
                // ÂêÑÂøúÊâã„Å´ÂØæ„Åó„Å¶Ë©∞„Åø„ÇíÁ¢∫Ë™ç
                for (const evasion of evasions) {
                    const backup = this.makeMove(evasion);
                    
                    if (!this.isCheck('gote')) {
                        // ÁéãÊâã„ÅåËß£Èô§„Åï„Çå„ÅüÂ†¥Âêà„ÄÅÂÖàÊâã„ÅÆË©∞„ÅøÊâã„ÇíÊé¢„Åô
                        const checks = this.generateChecks();
                        
                        for (const check of checks) {
                            const backup2 = this.makeMove(check);
                            const finalEvasions = this.generateEvasions();
                            
                            if (finalEvasions.length === 0) {
                                // Ë©∞„ÅøÁô∫Ë¶ã
                                variations.push({
                                    moves: [this.formatMove(evasion), this.formatMove(check)],
                                    result: 'Ë©∞„Åø'
                                });
                            }
                            
                            this.unmakeMove(check, backup2);
                        }
                    }
                    
                    this.unmakeMove(evasion, backup);
                }
                
                return variations;
            }
            
            // Êé¢Á¥¢Êú¨‰ΩìÔºàÂçò‰∏Ä„ÅÆÊâãÈ†Ü„ÅÆ„ÅøÔºâ
            search(depth, isSente) {
                // Ê∑±„Åï0„ÅÆÂ†¥Âêà
                if (depth === 0) {
                    // ÂæåÊâã„ÅåÁéãÊâã„Åï„Çå„Å¶„ÅÑ„Çã„ÅãÁ¢∫Ë™çÔºàÊâãÁï™„Å´Èñ¢‰øÇ„Å™„ÅèÔºâ
                    if (this.isCheck('gote')) {
                        const evasions = this.generateEvasions();
                        if (evasions.length === 0) {
                            return []; // Ë©∞„Åø
                        }
                    }
                    return null;
                }
                
                // „Éé„Éº„ÉâÊï∞Âà∂Èôê„ÉÅ„Çß„ÉÉ„ÇØ
                this.nodeCount++;
                if (this.nodeCount > this.maxNodes) {
                    if (this.debugMode) {
                        this.debugLog(`„Éé„Éº„ÉâÊï∞Âà∂Èôê(${this.maxNodes})„Å´Âà∞ÈÅî`);
                    }
                    return null;
                }
                
                // ÊôÇÈñìÂà∂Èôê„ÉÅ„Çß„ÉÉ„ÇØ
                if (this.nodeCount % 1000 === 0) {
                    const elapsed = Date.now() - this.searchStartTime;
                    if (elapsed > this.maxSearchTime) {
                        if (this.debugMode) {
                            this.debugLog(`ÊôÇÈñìÂà∂Èôê(${this.maxSearchTime}ms)„Å´Âà∞ÈÅî`);
                        }
                        return null;
                    }
                }
                
                // ÂçÉÊó•Êâã„ÉÅ„Çß„ÉÉ„ÇØÔºàÊ∑±„Åï„ÇÇËÄÉÊÖÆÔºâ
                const positionKey = this.hashPosition() + '_d' + depth;
                const repetitions = this.repetitionTable.get(positionKey) || 0;
                if (repetitions >= 2) {  // 2ÂõûÁõÆ„ÅßÂçÉÊó•ÊâãÂà§ÂÆöÔºà3ÂõûÁõÆ„ÇíÂæÖ„Åü„Å™„ÅÑÔºâ
                    if (this.debugMode && repetitions === 2) {
                        this.debugLog('ÂçÉÊó•Êâã„ÇíÊ§úÂá∫ÔºàÂêå‰∏ÄÂ±ÄÈù¢2ÂõûÁõÆÔºâ');
                    }
                    return null;
                }
                this.repetitionTable.set(positionKey, repetitions + 1);
                
                // „Éá„Éê„ÉÉ„Ç∞„É≠„Ç∞
                if (this.debugMode && this.nodeCount % 1000 === 0) {
                    this.debugLog(`[ÈÄ≤Êçó] „Éé„Éº„ÉâÊï∞: ${this.nodeCount}, Ê∑±„Åï: ${depth}, ÊâãÁï™: ${isSente ? 'ÂÖàÊâã' : 'ÂæåÊâã'}`);
                }
                
                // „Éè„ÉÉ„Ç∑„É•Ë°®Á¢∫Ë™çÔºàÊîπÂñÑÁâàÔºâ
                const hash = this.hashPosition() + '_' + isSente;
                const cached = this.hashTable.get(hash);
                if (cached && cached.depth >= depth) {
                    // ÂçÉÊó•Êâã„Ç´„Ç¶„É≥„Éà„ÇíÊàª„Åô
                    this.repetitionTable.set(positionKey, Math.max(0, repetitions - 1));
                    return cached.result;
                }
                
                // ÁèæÂú®„ÅÆÁä∂ÊÖãÁ¢∫Ë™ç
                const isCheck = this.isCheck(isSente ? 'gote' : 'sente');
                
                if (isSente) {
                    // ÂÖàÊâãÁï™ÔºöÁéãÊâã„Çí„Åã„Åë„Çã
                    let moves = this.generateChecks();
                    
                    if (this.debugMode && depth <= 3) {
                        this.debugLog(`[ÂÖàÊâã] ÁéãÊâãÂèØËÉΩÊâãÊï∞: ${moves.length}`);
                        if (moves.length > 0 && moves.length <= 10) {
                            this.debugLog(`  Êâã: ${moves.slice(0, 10).map(m => this.formatMove(m)).join(', ')}`);
                        }
                    }
                    
                    // Êâã„ÅÆ‰∏¶„Å≥Êõø„ÅàÔºàËâØ„ÅÑÊâã„ÇíÂÖà„Å´Ë©¶„ÅôÔºâ
                    moves = this.orderMoves(moves, depth);
                    
                    for (const move of moves) {
                        const backup = this.makeMove(move);
                        const result = this.search(depth - 1, false);
                        this.unmakeMove(move, backup);
                        
                        if (result !== null) {
                            const solution = [this.formatMove(move), ...result];
                            this.hashTable.set(hash, { depth, result: solution });
                            
                            // „Ç≠„É©„Éº„É†„Éº„Éñ„Å®„Åó„Å¶Ë®òÈå≤
                            this.recordKillerMove(depth, move);
                            
                            // ÂçÉÊó•Êâã„Ç´„Ç¶„É≥„Éà„ÇíÊàª„Åô
                            this.repetitionTable.set(positionKey, Math.max(0, repetitions - 1));
                            return solution;
                        }
                    }
                    
                    this.hashTable.set(hash, { depth, result: null });
                    // ÂçÉÊó•Êâã„Ç´„Ç¶„É≥„Éà„ÇíÊàª„Åô
                    this.repetitionTable.set(positionKey, Math.max(0, repetitions - 1));
                    return null;
                    
                } else {
                    // ÂæåÊâãÁï™ÔºöÁéãÊâãÂõûÈÅø
                    if (!this.isCheck('gote')) {
                        // ÂæåÊâã„ÅåÁéãÊâã„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅØË©∞„Åø„Åß„ÅØ„Å™„ÅÑ
                        if (this.debugMode && depth <= 3) {
                            this.debugLog(`[ÂæåÊâã] ÁéãÊâã„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑ„ÅÆ„ÅßË©∞„Åø„Åß„ÅØ„Å™„ÅÑ`);
                        }
                        // ÂçÉÊó•Êâã„Ç´„Ç¶„É≥„Éà„ÇíÊàª„Åô
                        this.repetitionTable.set(positionKey, Math.max(0, repetitions - 1));
                        return null;
                    }
                    
                    const moves = this.generateEvasions();
                    
                    if (this.debugMode && depth <= 5) {
                        this.debugLog(`[ÂæåÊâã] ÁéãÊâãÂõûÈÅøÊâãÊï∞: ${moves.length}`);
                        if (moves.length === 0) {
                            this.debugLog(`  Ë©∞„ÅøÔºÅ`);
                        } else if (moves.length <= 5) {
                            this.debugLog(`  Êâã: ${moves.map(m => this.formatMove(m)).join(', ')}`);
                        }
                    }
                    
                    if (moves.length === 0) {
                        // ÂçÉÊó•Êâã„Ç´„Ç¶„É≥„Éà„ÇíÊàª„Åô
                        this.repetitionTable.set(positionKey, Math.max(0, repetitions - 1));
                        return [];  // Ë©∞„Åø
                    }
                    
                    // „Åô„Åπ„Å¶„ÅÆÂõûÈÅøÊâã„ÇíË©¶„Åô
                    let bestResult = null;
                    for (const move of moves) {
                        const backup = this.makeMove(move);
                        
                        // ÁéãÊâã„ÅåËß£Èô§„Åï„Çå„Å¶„ÅÑ„Çã„ÅãÁ¢∫Ë™ç
                        if (!this.isCheck('gote')) {
                            const result = this.search(depth - 1, true);
                            this.unmakeMove(move, backup);
                            
                            if (result === null) {
                                this.hashTable.set(hash, { depth, result: null });
                                // ÂçÉÊó•Êâã„Ç´„Ç¶„É≥„Éà„ÇíÊàª„Åô
                                this.repetitionTable.set(positionKey, Math.max(0, repetitions - 1));
                                return null;  // „Åì„ÅÆÊâã„ÅßÈÄÉ„Åí„Çâ„Çå„Çã
                            } else if (result !== null) {
                                // „Åì„ÅÆÂøúÊâã„Å´ÂØæ„Åó„Å¶Ë©∞„Åø„Åå„ÅÇ„Çã„ÅÆ„ÅßË®òÈå≤
                                bestResult = [this.formatMove(move), ...result];
                            }
                        } else {
                            this.unmakeMove(move, backup);
                        }
                    }
                    
                    // „Åô„Åπ„Å¶„ÅÆÊâã„ÅßË©∞„ÇÄÂ†¥Âêà„ÅØÊúÄÁü≠„ÅÆÊâãÈ†Ü„ÇíËøî„Åô
                    if (bestResult !== null) {
                        this.hashTable.set(hash, { depth, result: bestResult });
                        // ÂçÉÊó•Êâã„Ç´„Ç¶„É≥„Éà„ÇíÊàª„Åô
                        this.repetitionTable.set(positionKey, Math.max(0, repetitions - 1));
                        return bestResult;
                    }
                    
                    // „Åô„Åπ„Å¶„ÅÆÊâã„ÅßË©∞„ÇÄÔºàÁéãÊâã„ÅåËß£Èô§„Åß„Åç„Å™„ÅÑÂ†¥ÂêàÔºâ
                    this.hashTable.set(hash, { depth, result: [] });
                    // ÂçÉÊó•Êâã„Ç´„Ç¶„É≥„Éà„ÇíÊàª„Åô
                    this.repetitionTable.set(positionKey, Math.max(0, repetitions - 1));
                    return [];
                }
            }

            // ÁéãÊâãÁîüÊàêÔºàÈñã„ÅçÁéãÊâã„ÇÇÂê´„ÇÄÔºâ
            generateChecks() {
                const checks = [];
                
                // Áõ§‰∏ä„ÅÆÈßí„ÅÆÁßªÂãï
                for (let row = 0; row < 9; row++) {
                    for (let col = 0; col < 9; col++) {
                        const piece = this.board[row][col];
                        if (piece && piece.side === 'sente') {
                            const moves = this.getPieceMoves(row, col, piece);
                            
                            // „Éá„Éê„ÉÉ„Ç∞ÔºöÔºí‰∫åÈ£õ„ÅÆÊâã„ÇíÁ¢∫Ë™ç
                            if (this.debugMode && row === 1 && col === 7 && piece.piece === 'È£õ') {
                                this.debugLog(`Ôºí‰∫åÈ£õ„ÅÆÁîüÊàê„Åï„Çå„ÅüÊâãÊï∞: ${moves.length}`);
                                for (const m of moves) {
                                    if (m.to === 'Ôºí‰∏Ä') {
                                        this.debugLog(`  Ôºí‰∏Ä„Å∏„ÅÆÊâã: piece=${m.piece}, promote=${m.promote}`);
                                    }
                                }
                            }
                            
                            for (const move of moves) {
                                // move„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Çí„Ç≥„Éî„Éº„Åó„Å¶„ÄÅÂÖÉ„ÅÆ„Éá„Éº„Çø„Çí‰øùÊåÅ
                                const moveCopy = {...move};
                                const backup = this.makeMove(move);
                                // ÁßªÂãïÂæå„Å´ÁéãÊâã„Å´„Å™„Å£„Å¶„ÅÑ„Çã„ÅãÔºàÁõ¥Êé•ÁéãÊâã„Åæ„Åü„ÅØÈñã„ÅçÁéãÊâãÔºâ
                                if (this.isCheck('gote')) {
                                    // „Ç≥„Éî„Éº„Åó„ÅüÊñπ„Çí‰ΩøÁî®
                                    checks.push(moveCopy);
                                    if (this.debugMode) {
                                        this.debugLog(`ÁéãÊâãÁô∫Ë¶ã: ${this.formatMove(moveCopy)}`);
                                    }
                                }
                                this.unmakeMove(move, backup);
                            }
                        }
                    }
                }
                
                // ÊåÅ„Å°Èßí„ÇíÊâì„Å§
                for (const [piece, count] of Object.entries(this.mochiGoma.sente)) {
                    if (count > 0) {
                        for (let row = 0; row < 9; row++) {
                            for (let col = 0; col < 9; col++) {
                                if (!this.board[row][col] && this.canDrop(piece, row, col)) {
                                    const move = {
                                        type: 'drop',
                                        piece: piece,
                                        to: internalToHuman(row, col)
                                    };
                                    
                                    const backup = this.makeMove(move);
                                    if (this.isCheck('gote')) {
                                        checks.push(move);
                                    }
                                    this.unmakeMove(move, backup);
                                }
                            }
                        }
                    }
                }
                
                return checks;
            }

            // ÁéãÊâãÂõûÈÅøÊâãÁîüÊàê
            generateEvasions() {
                const evasions = [];
                
                // Áéâ„ÇíÊé¢„Åô
                let kingPos = null;
                for (let row = 0; row < 9; row++) {
                    for (let col = 0; col < 9; col++) {
                        const piece = this.board[row][col];
                        if (piece && piece.piece === 'Áéâ' && piece.side === 'gote') {
                            kingPos = [row, col];
                            break;
                        }
                    }
                }
                
                if (!kingPos) return evasions;
                
                if (this.debugMode) {
                    this.debugLog(`  ÂæåÊâãÁéâ„ÅÆ‰ΩçÁΩÆ: ${internalToHuman(kingPos[0], kingPos[1])}`);
                    // ÊîªÊíÉÈßí„ÅÆÁ¢∫Ë™ç
                    const attackers = this.getAttackers(kingPos[0], kingPos[1], 'sente');
                    if (attackers.length > 0) {
                        for (const att of attackers) {
                            const p = this.board[att[0]][att[1]];
                            this.debugLog(`  ÁéãÊâã„Åó„Å¶„ÅÑ„ÇãÈßí: ${p.piece} at ${internalToHuman(att[0], att[1])}`);
                        }
                    }
                }
                
                // 1. Áéâ„ÅÆÁßªÂãï
                const kingMoves = this.getKingMoves(kingPos[0], kingPos[1]);
                for (const move of kingMoves) {
                    const backup = this.makeMove(move);
                    // ÁßªÂãïÂæå„ÇÇÁéãÊâã„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑ„ÅãÁ¢∫Ë™ç
                    if (!this.isCheck('gote')) {
                        evasions.push(move);
                    }
                    this.unmakeMove(move, backup);
                }
                
                // 2. ÁéãÊâã„Åó„Å¶„ÅÑ„ÇãÈßí„ÇíÂèñ„Çã
                const attackers = this.getAttackers(kingPos[0], kingPos[1], 'sente');
                if (this.debugMode) {
                    this.debugLog(`  ÊîªÊíÉËÄÖÊï∞: ${attackers.length}`);
                    if (attackers.length > 0) {
                        for (const att of attackers) {
                            const p = this.board[att[0]][att[1]];
                            this.debugLog(`    ÊîªÊíÉËÄÖ: ${p.piece} at ${internalToHuman(att[0], att[1])}`);
                        }
                    }
                }
                if (attackers.length === 1) {  // ‰∏°ÁéãÊâã„Åß„Å™„ÅÑÂ†¥Âêà„ÅÆ„Åø
                    const attacker = attackers[0];
                    // ÂæåÊâã„ÅÆÈßí„ÅßÂèñ„Çå„Çã„ÅãÁ¢∫Ë™ç
                    for (let row = 0; row < 9; row++) {
                        for (let col = 0; col < 9; col++) {
                            const piece = this.board[row][col];
                            if (piece && piece.side === 'gote' && piece.piece !== 'Áéâ') {
                                if (this.canAttack(row, col, attacker[0], attacker[1], piece)) {
                                    const move = {
                                        type: 'move',
                                        from: internalToHuman(row, col),
                                        to: internalToHuman(attacker[0], attacker[1]),
                                        piece: piece.piece,
                                        captured: this.board[attacker[0]][attacker[1]]
                                    };
                                    evasions.push(move);
                                }
                            }
                        }
                    }
                }
                
                // 3. ÂêàÈßíÔºàÈ£õ„Å≥Èßí„Å´„Çà„ÇãÁéãÊâã„ÅÆÂ†¥ÂêàÔºâ
                if (attackers.length === 1) {
                    const attacker = attackers[0];
                    const attackPiece = this.board[attacker[0]][attacker[1]];
                    
                    if (this.debugMode) {
                        this.debugLog(`  ÂêàÈßí„ÉÅ„Çß„ÉÉ„ÇØÈñãÂßã: ÊîªÊíÉÈßí=${attackPiece.piece} at ${internalToHuman(attacker[0], attacker[1])}`);
                    }
                    
                    // È£õ„Å≥Èßí„Å´„Çà„ÇãÁéãÊâã„ÅãÁ¢∫Ë™ç
                    if (['È£õ', 'Èæç', 'Ëßí', 'È¶¨', 'È¶ô'].includes(attackPiece.piece)) {
                        if (this.debugMode) {
                            this.debugLog(`  ‚Üí È£õ„Å≥Èßí„Å´„Çà„ÇãÁéãÊâã„Å™„ÅÆ„ÅßÂêàÈßí„ÇíÊ§úË®é`);
                        }
                        // ÁéãÊâã„ÅÆÁ∑ö‰∏ä„ÅÆ„Éû„Çπ„ÇíÊé¢„Åô
                        const dr = Math.sign(kingPos[0] - attacker[0]);
                        const dc = Math.sign(kingPos[1] - attacker[1]);
                        
                        let r = attacker[0] + dr;
                        let c = attacker[1] + dc;
                        
                        while (r !== kingPos[0] || c !== kingPos[1]) {
                            // „Åì„ÅÆ„Éû„Çπ„Å´ÂêàÈßí„Åß„Åç„Çã„Åã
                            const blockPos = internalToHuman(r, c);
                            
                            if (this.debugMode) {
                                this.debugLog(`    ÂêàÈßíÂÄôË£ú‰ΩçÁΩÆ: ${blockPos} [${r},${c}]`);
                            }
                            
                            // ÂæåÊâã„ÅÆÈßí„ÇíÁßªÂãï„Åó„Å¶ÂêàÈßíÔºàÂäπÁéáÂåñ„ÅÆ„Åü„ÇÅÊó©ÊúüÁµÇ‰∫Ü„ÇíËøΩÂä†Ôºâ
                            let foundMoveBlock = false;
                            for (let row = 0; row < 9 && !foundMoveBlock; row++) {
                                for (let col = 0; col < 9 && !foundMoveBlock; col++) {
                                    const piece = this.board[row][col];
                                    if (piece && piece.side === 'gote' && piece.piece !== 'Áéâ') {
                                        const moves = this.getPieceMoves(row, col, piece);
                                        for (const move of moves) {
                                            if (move.to === blockPos) {
                                                evasions.push(move);
                                                // Ë§áÊï∞„ÅÆÂêàÈßíÂÄôË£ú„ÇíÂÖ®„Å¶ÂèéÈõÜÔºàÊúÄÂñÑÊâã„ÇíÈÅ∏„Å∂„Åü„ÇÅÔºâ
                                            }
                                        }
                                    }
                                }
                            }
                            
                            // ÂæåÊâã„ÅÆÊåÅÈßí„Åã„ÇâÂêàÈßí„ÇíÊâì„Å§
                            // Ë©∞Â∞ÜÊ£ã„Åß„ÅØÂÖàÊâã„ÅÆÊåÅÈßí‰ª•Â§ñ„ÅØÂÖ®„Å¶ÂæåÊâã„ÅåÊåÅ„Å£„Å¶„ÅÑ„Çã„Åü„ÇÅ„ÄÅ
                            // Áõ§‰∏ä„Å´„Å™„ÅÑÈßíÁ®Æ„ÇíÂæåÊâã„ÅÆÊåÅÈßí„Å®„Åó„Å¶Êâ±„ÅÜ
                            const [blockRow, blockCol] = humanToInternal(blockPos);
                            
                            // Á©∫„Åç„Éû„Çπ„ÅãÁ¢∫Ë™ç
                            if (this.board[blockRow][blockCol]) {
                                if (this.debugMode) {
                                    this.debugLog(`    ‚Üí ${blockPos}„ÅØÂüã„Åæ„Å£„Å¶„ÅÑ„Çã„ÅÆ„Åß„Çπ„Ç≠„ÉÉ„Éó`);
                                }
                                r += dr;
                                c += dc;
                                continue;
                            }
                            
                            if (this.debugMode) {
                                this.debugLog(`    ‚Üí ${blockPos}„ÅØÁ©∫„Åç„Éû„Çπ„ÄÅÂêàÈßí„ÇíÊ§úË®é`);
                            }
                            
                            // „Åæ„Åö„ÄÅ„Åì„ÅÆÂú∞ÁÇπ„Å∏„ÅÆÊîªÊíÉËÄÖÊï∞„ÇíÁ¢∫Ë™çÔºà‰∏°Âäπ„ÅçÂà§ÂÆöÔºâ
                            const blockAttackers = this.getAttackers(blockRow, blockCol, 'sente');
                            
                            // ‰∏°Âäπ„ÅçÔºà2„Å§‰ª•‰∏ä„ÅÆÈßí„ÅßÊîªÊíÉÔºâ„ÅÆÂ†¥Âêà„ÄÅÂêàÈßí„ÅØÁÑ°Âäπ
                            if (blockAttackers.length <= 1) {
                                // ÂêàÈßí„ÅÆÂÑ™ÂÖàÈ†Ü‰ΩçÔºà‰æ°ÂÄ§„ÅÆ‰Ωé„ÅÑÈßí„Åã„ÇâË©¶„ÅôÔºâ
                                // Ë©∞Â∞ÜÊ£ã„Åß„ÅØÈÄöÂ∏∏„ÄÅÊúÄ„ÇÇÂÆâ„ÅÑÈßí„ÅßÂêàÈßí„Åô„Çã„ÅÆ„ÅåÊúÄÂñÑ
                                const pieceOrder = ['Ê≠©', 'È¶ô', 'Ê°Ç', 'ÈäÄ', 'Èáë', 'Ëßí', 'È£õ'];
                                
                                if (this.debugMode) {
                                    this.debugLog(`    ÂêàÈßí„ÇíÊâì„Å§ÂÄôË£ú‰ΩçÁΩÆ: ${blockPos} (‰∏°Âäπ„ÅçÊï∞: ${blockAttackers.length})`);
                                    // ÂæåÊâã„ÅÆ‰Ωø„Åà„ÇãÈßí„ÇíÁ¢∫Ë™ç
                                    const usablePieces = [];
                                    for (const p of ['Ê≠©', 'È¶ô', 'Ê°Ç', 'ÈäÄ', 'Èáë', 'Ëßí', 'È£õ']) {
                                        if (this.canGoteUsePiece(p)) {
                                            usablePieces.push(p);
                                        }
                                    }
                                    this.debugLog(`    ÂæåÊâã„Åå‰Ωø„Åà„ÇãÈßí: ${usablePieces.join(', ')}`);
                                }
                                
                                // ÂêÑÈßíÁ®Æ„Å´„Å§„ÅÑ„Å¶ÂêàÈßí„ÇíË©¶„Åô
                                for (const piece of pieceOrder) {
                                    // „Åì„ÅÆÈßíÁ®Æ„ÅåÂæåÊâã„ÅÆÊåÅÈßí„Å®„Åó„Å¶‰Ωø„Åà„Çã„ÅãÁ¢∫Ë™ç
                                    if (this.canGoteUsePiece(piece)) {
                                        // Êâì„Å¶„ÇãÂ†¥ÊâÄ„ÅãÁ¢∫Ë™çÔºà‰∫åÊ≠©„ÄÅË°å„ÅçÊâÄ„ÅÆ„Å™„ÅÑÈßí„ÉÅ„Çß„ÉÉ„ÇØÔºâ
                                        if (this.canDropGote(piece, blockRow, blockCol)) {
                                            // „Åì„ÅÆÂêàÈßí„ÅåÊúâÂäπ„Åã„Å©„ÅÜ„ÅãÂà§ÂÆö
                                            const testMove = {
                                                type: 'drop',
                                                piece: piece,
                                                to: blockPos,
                                                side: 'gote'
                                            };
                                            
                                            if (this.debugMode) {
                                                this.debugLog(`      ${piece}„Çí${blockPos}„Å´Êâì„Å§„Åì„Å®„ÇíÊ§úË®é`);
                                            }
                                            
                                            // ÂêàÈßí„ÇíÂÆüË°å„Åó„Å¶„Åø„Çã
                                            const backup = this.makeMove(testMove);
                                            const stillInCheck = this.isCheck('gote');
                                            this.unmakeMove(testMove, backup);
                                            
                                            // ÁéãÊâã„ÅåËß£Èô§„Åï„Çå„Çå„Å∞ÊúâÂäπ„Å™ÂêàÈßí
                                            if (!stillInCheck) {
                                                if (this.debugMode) {
                                                    this.debugLog(`      ‚Üí ÊúâÂäπ„Å™ÂêàÈßí: ‚ñ≥${blockPos}${piece}Êâì`);
                                                }
                                                evasions.push(testMove);
                                                // Ë§áÊï∞„ÅÆÂêàÈßí„ÇíÂÖ®„Å¶ËÄÉÊÖÆÔºàÊúÄÂñÑÊâã„ÇíÊé¢„Åô„Åü„ÇÅÔºâ
                                            }
                                        }
                                    }
                                }
                            }
                            
                            r += dr;
                            c += dc;
                        }
                    }
                }
                
                return evasions;
            }

            // ÁâπÂÆö„ÅÆ„Éû„Çπ„ÇíÊîªÊíÉ„Åó„Å¶„ÅÑ„ÇãÈßí„ÇíÂèñÂæó
            getAttackers(targetRow, targetCol, attackerSide) {
                const attackers = [];
                
                for (let row = 0; row < 9; row++) {
                    for (let col = 0; col < 9; col++) {
                        const piece = this.board[row][col];
                        if (piece && piece.side === attackerSide) {
                            if (this.canAttack(row, col, targetRow, targetCol, piece)) {
                                attackers.push([row, col]);
                            }
                        }
                    }
                }
                
                return attackers;
            }

            // Èßí„ÅÆÂãï„ÅçÁîüÊàê
            getPieceMoves(row, col, piece) {
                const moves = [];
                const from = internalToHuman(row, col);
                const directions = this.getPieceDirections(piece.piece, piece.side);
                
                for (const dir of directions) {
                    // È£õ„Å≥Èßí„Åã„Å©„ÅÜ„ÅãÂà§ÂÆö
                    const isRangedPiece = ['È£õ', 'Èæç', 'Ëßí', 'È¶¨', 'È¶ô'].includes(piece.piece);
                    const maxRange = isRangedPiece ? 8 : 1;
                    
                    for (let dist = 1; dist <= maxRange; dist++) {
                        const newRow = row + dir.row * dist;
                        const newCol = col + dir.col * dist;
                        
                        if (!this.isInBoard(newRow, newCol)) break;
                        
                        const target = this.board[newRow][newCol];
                        if (target && target.side === piece.side) break;
                        
                        const to = internalToHuman(newRow, newCol);
                        // Êàê„Çå„ÇãÂ†¥Âêà„ÅØÊàê„Çâ„Åö„Å®Êàê„Çä„ÅÆ‰∏°Êñπ„ÇíÁîüÊàêÔºàÂº∑Âà∂Êàê„Çä„ÇíÈô§„ÅèÔºâ
                        const canProm = this.canPromote(piece.piece, row, newRow, piece.side);
                        const mustProm = this.mustPromote(piece.piece, row, newRow, piece.side);
                        
                        // Âº∑Âà∂Êàê„Çä„Åß„Å™„Åë„Çå„Å∞„ÄÅÊàê„Çâ„Åö„ÅÆÊâã„ÇíÁîüÊàê
                        if (!mustProm) {
                            // Êàê„Çâ„Åö„ÅÆÊâã
                            moves.push({
                                type: 'move',
                                from: from,
                                to: to,
                                piece: piece.piece,
                                captured: target,
                                side: piece.side
                            });
                        }
                        
                        // Êàê„Çå„ÇãÂ†¥Âêà„ÅØÊàê„Çä„ÅÆÊâã„ÇÇÁîüÊàê
                        if (canProm) {
                            // Êàê„Çä„ÅÆÊâã
                            moves.push({
                                type: 'move',
                                from: from,
                                to: to,
                                piece: piece.piece,
                                captured: target,
                                promote: true,
                                side: piece.side
                            });
                        }
                        
                        // Âº∑Âà∂Êàê„Çä„ÅÆÂ†¥Âêà„ÄÅÊàê„Çâ„Åö„ÅÆÊâã„Åå„Å™„ÅÑ„Åì„Å®„ÇíÁ¢∫Ë™ç
                        if (mustProm && !canProm) {
                            // „Ç®„É©„ÉºÔºöÂº∑Âà∂Êàê„Çä„Å™„ÅÆ„Å´Êàê„Çå„Å™„ÅÑ
                            console.error('Âº∑Âà∂Êàê„Çä„Ç®„É©„Éº:', piece.piece, from, to);
                        }
                        
                        // Èßí„ÇíÂèñ„Å£„Åü„ÇâÊ≠¢„Åæ„Çã
                        if (target) break;
                    }
                }
                
                return moves;
            }

            // Áéâ„ÅÆÂãï„Åç
            getKingMoves(row, col) {
                const moves = [];
                const from = internalToHuman(row, col);
                const dirs = [
                    [-1, -1], [-1, 0], [-1, 1],
                    [0, -1], [0, 1],
                    [1, -1], [1, 0], [1, 1]
                ];
                
                for (const [dr, dc] of dirs) {
                    const newRow = row + dr;
                    const newCol = col + dc;
                    if (this.isInBoard(newRow, newCol)) {
                        const target = this.board[newRow][newCol];
                        if (!target || target.side !== 'gote') {
                            moves.push({
                                type: 'move',
                                from: from,
                                to: internalToHuman(newRow, newCol),
                                piece: 'Áéâ',
                                captured: target,
                                side: 'gote'
                            });
                        }
                    }
                }
                
                return moves;
            }

            // Èßí„ÅÆÊñπÂêëÂÆöÁæ©ÔºàÁ∞°Áï•ÁâàÔºâ
            getPieceDirections(piece, side) {
                const mult = side === 'sente' ? -1 : 1;
                const basicDirs = {
                    'Ê≠©': [{row: mult, col: 0}],
                    'È¶ô': [{row: mult, col: 0}],
                    'Ê°Ç': [{row: mult * 2, col: -1}, {row: mult * 2, col: 1}],
                    'ÈäÄ': [
                        {row: mult, col: -1}, {row: mult, col: 0}, {row: mult, col: 1},
                        {row: -mult, col: -1}, {row: -mult, col: 1}
                    ],
                    'Èáë': [
                        {row: mult, col: -1}, {row: mult, col: 0}, {row: mult, col: 1},
                        {row: 0, col: -1}, {row: 0, col: 1},
                        {row: -mult, col: 0}
                    ],
                    'Ëßí': [
                        {row: -1, col: -1}, {row: -1, col: 1},
                        {row: 1, col: -1}, {row: 1, col: 1}
                    ],
                    'È£õ': [
                        {row: -1, col: 0}, {row: 1, col: 0},
                        {row: 0, col: -1}, {row: 0, col: 1}
                    ],
                    'Áéâ': [
                        {row: -1, col: -1}, {row: -1, col: 0}, {row: -1, col: 1},
                        {row: 0, col: -1}, {row: 0, col: 1},
                        {row: 1, col: -1}, {row: 1, col: 0}, {row: 1, col: 1}
                    ],
                    'Èæç': [
                        {row: -1, col: 0}, {row: 1, col: 0},
                        {row: 0, col: -1}, {row: 0, col: 1},
                        {row: -1, col: -1}, {row: -1, col: 1},
                        {row: 1, col: -1}, {row: 1, col: 1}
                    ],
                    'È¶¨': [
                        {row: -1, col: -1}, {row: -1, col: 1},
                        {row: 1, col: -1}, {row: 1, col: 1},
                        {row: -1, col: 0}, {row: 1, col: 0},
                        {row: 0, col: -1}, {row: 0, col: 1}
                    ]
                };
                
                // ÊàêÈßí„ÅØÈáë„ÅÆÂãï„Åç
                const goldMove = basicDirs['Èáë'];
                basicDirs['„Å®'] = goldMove;
                basicDirs['Êùè'] = goldMove;
                basicDirs['Âú≠'] = goldMove;
                basicDirs['ÂÖ®'] = goldMove;
                
                return basicDirs[piece] || [];
            }

            // Êâã„ÇíÂÆüË°å
            makeMove(move) {
                const backup = {
                    board: null,
                    mochiGoma: JSON.parse(JSON.stringify(this.mochiGoma))
                };
                
                if (move.type === 'drop') {
                    const [row, col] = humanToInternal(move.to);
                    const side = move.side || 'sente';  // „Éá„Éï„Ç©„É´„Éà„ÅØÂÖàÊâã
                    this.board[row][col] = { piece: move.piece, side: side };
                    
                    // ÂÖàÊâã„ÅÆÊåÅÈßí„Åã„ÇâÊ∏õ„Çâ„ÅôÔºàÂæåÊâã„ÅÆÂêàÈßí„ÅØ‰ªÆÊÉ≥ÁöÑ„Å´ÁÑ°Èôê„Å´„ÅÇ„Çã„ÅÆ„ÅßÊ∏õ„Çâ„Åï„Å™„ÅÑÔºâ
                    if (side === 'sente' && this.mochiGoma.sente[move.piece]) {
                        this.mochiGoma.sente[move.piece]--;
                        if (this.mochiGoma.sente[move.piece] === 0) {
                            delete this.mochiGoma.sente[move.piece];
                        }
                    }
                    // ÂæåÊâã„ÅÆÂêàÈßíÊâì„Å°„ÅØÊåÅÈßí„ÇíÁÆ°ÁêÜ„Åó„Å™„ÅÑÔºàË©∞Â∞ÜÊ£ã„Åß„ÅØÂæåÊâã„ÅØÁõ§‰∏ä„Å´„Å™„ÅÑÈßí„ÇíÂÖ®„Å¶ÊåÅ„Å£„Å¶„ÅÑ„ÇãÔºâ
                } else {
                    const [fromRow, fromCol] = humanToInternal(move.from);
                    const [toRow, toCol] = humanToInternal(move.to);
                    
                    backup.board = this.board[toRow][toCol];
                    
                    const movingPiece = this.board[fromRow][fromCol];
                    if (move.promote) {
                        this.board[toRow][toCol] = {
                            piece: this.promotePiece(move.piece),
                            side: movingPiece.side
                        };
                    } else {
                        this.board[toRow][toCol] = movingPiece;
                    }
                    this.board[fromRow][fromCol] = null;
                    
                    // Èßí„ÇíÂèñ„Å£„ÅüÂ†¥Âêà
                    if (backup.board) {
                        const demoted = this.demotePiece(backup.board.piece);
                        if (!this.mochiGoma.sente[demoted]) {
                            this.mochiGoma.sente[demoted] = 0;
                        }
                        this.mochiGoma.sente[demoted]++;
                    }
                }
                
                return backup;
            }

            // Êâã„ÇíÊàª„Åô
            unmakeMove(move, backup) {
                if (move.type === 'drop') {
                    const [row, col] = humanToInternal(move.to);
                    this.board[row][col] = null;
                } else {
                    const [fromRow, fromCol] = humanToInternal(move.from);
                    const [toRow, toCol] = humanToInternal(move.to);
                    
                    this.board[fromRow][fromCol] = this.board[toRow][toCol];
                    if (move.promote) {
                        this.board[fromRow][fromCol].piece = move.piece;
                    }
                    this.board[toRow][toCol] = backup.board;
                }
                
                this.mochiGoma = backup.mochiGoma;
            }

            // ÁéãÊâãÂà§ÂÆö
            isCheck(side) {
                let kingPos = null;
                for (let row = 0; row < 9; row++) {
                    for (let col = 0; col < 9; col++) {
                        const piece = this.board[row][col];
                        if (piece && piece.piece === 'Áéâ' && piece.side === side) {
                            kingPos = [row, col];
                            break;
                        }
                    }
                }
                
                if (!kingPos) return false;
                
                const enemySide = side === 'sente' ? 'gote' : 'sente';
                
                // ÂêÑÊïµÈßí„Åã„ÇâÊîªÊíÉ„Åï„Çå„Å¶„ÅÑ„Çã„Åã
                for (let row = 0; row < 9; row++) {
                    for (let col = 0; col < 9; col++) {
                        const piece = this.board[row][col];
                        if (piece && piece.side === enemySide) {
                            if (this.canAttack(row, col, kingPos[0], kingPos[1], piece)) {
                                return true;
                            }
                        }
                    }
                }
                
                return false;
            }

            // ÊîªÊíÉÂà§ÂÆöÔºà‰øÆÊ≠£ÁâàÔºâ
            canAttack(fromRow, fromCol, toRow, toCol, piece) {
                const dr = toRow - fromRow;
                const dc = toCol - fromCol;
                
                // Âêå„Åò‰ΩçÁΩÆ„Å™„ÇâÊîªÊíÉ„Åß„Åç„Å™„ÅÑ
                if (dr === 0 && dc === 0) return false;
                
                // ÈßíÁ®ÆÂà•„ÅÆÊîªÊíÉÂà§ÂÆö
                switch (piece.piece) {
                    case 'Ê≠©':
                        // Ê≠©„ÅØ1„Éû„ÇπÂâçÈÄ≤„ÅÆ„Åø
                        const pawnDir = piece.side === 'sente' ? -1 : 1;
                        return dr === pawnDir && dc === 0;
                    
                    case 'È¶ô':
                        // È¶ôËªä„ÅØÂâçÊñπÁõ¥Á∑öÔºàÂÖàÊâã„ÅØ‰∏ä„ÄÅÂæåÊâã„ÅØ‰∏ãÔºâ
                        const lanceDir = piece.side === 'sente' ? -1 : 1;
                        if (dc !== 0 || Math.sign(dr) !== lanceDir) return false;
                        // ÈÄî‰∏≠„Å´Èßí„Åå„Å™„ÅÑ„ÅãÁ¢∫Ë™ç
                        return this.checkClearPath(fromRow, fromCol, toRow, toCol);
                    
                    case 'Ê°Ç':
                        // Ê°ÇÈ¶¨„ÅØ2„Éû„ÇπÂâçÔºã1„Éû„ÇπÊ®™
                        const knightDir = piece.side === 'sente' ? -2 : 2;
                        return dr === knightDir && Math.abs(dc) === 1;
                    
                    case 'ÈäÄ':
                        // ÈäÄ„ÅØÂâç3ÊñπÂêë„Å®Âæå„ÇçÊñú„ÇÅ
                        const silverForward = piece.side === 'sente' ? -1 : 1;
                        if (Math.abs(dr) === 1 && Math.abs(dc) === 1) return true; // Êñú„ÇÅ
                        if (dr === silverForward && dc === 0) return true; // Ââç
                        return false;
                    
                    case 'Èáë':
                    case '„Å®':
                    case 'Êùè':
                    case 'Âú≠':
                    case 'ÂÖ®':
                        // Èáë„Å®ÊàêÈßí„ÅØÈáë„ÅÆÂãï„ÅçÔºàÂâç3ÊñπÂêë„ÄÅÊ®™2ÊñπÂêë„ÄÅÂæå„Çç1ÊñπÂêëÔºâ
                        const goldForward = piece.side === 'sente' ? -1 : 1;
                        const goldBackward = -goldForward;
                        if (Math.abs(dr) <= 1 && Math.abs(dc) <= 1) {
                            // Âæå„ÇçÊñú„ÇÅ„ÅØ‰∏çÂèØ
                            if (dr === goldBackward && dc !== 0) return false;
                            return true;
                        }
                        return false;
                    
                    case 'È£õ':
                        // È£õËªä„ÅØÁ∏¶Ê®™Áõ¥Á∑ö
                        if (dr !== 0 && dc !== 0) return false;
                        return this.checkClearPath(fromRow, fromCol, toRow, toCol);
                    
                    case 'Èæç':
                        // Èæç„ÅØÈ£õËªä„ÅÆÂãï„ÅçÔºãÊñú„ÇÅ1„Éû„Çπ
                        if (Math.abs(dr) === 1 && Math.abs(dc) === 1) return true; // Êñú„ÇÅ1„Éû„Çπ
                        if (dr === 0 || dc === 0) {
                            return this.checkClearPath(fromRow, fromCol, toRow, toCol);
                        }
                        return false;
                    
                    case 'Ëßí':
                        // Ëßí„ÅØÊñú„ÇÅÁõ¥Á∑ö
                        if (Math.abs(dr) !== Math.abs(dc)) return false;
                        return this.checkClearPath(fromRow, fromCol, toRow, toCol);
                    
                    case 'È¶¨':
                        // È¶¨„ÅØËßí„ÅÆÂãï„ÅçÔºãÁ∏¶Ê®™1„Éû„Çπ
                        if (Math.abs(dr) === 1 && dc === 0) return true; // Á∏¶1„Éû„Çπ
                        if (dr === 0 && Math.abs(dc) === 1) return true; // Ê®™1„Éû„Çπ
                        if (Math.abs(dr) === Math.abs(dc)) {
                            return this.checkClearPath(fromRow, fromCol, toRow, toCol);
                        }
                        return false;
                    
                    case 'Áéâ':
                        // Áéâ„ÅØ8ÊñπÂêë1„Éû„Çπ
                        return Math.abs(dr) <= 1 && Math.abs(dc) <= 1;
                    
                    default:
                        return false;
                }
            }

            // ÁµåË∑Ø‰∏ä„Å´Èßí„Åå„Å™„ÅÑ„ÅãÁ¢∫Ë™çÔºàÈ£õ„Å≥ÈßíÁî®Ôºâ
            checkClearPath(fromRow, fromCol, toRow, toCol) {
                const dr = Math.sign(toRow - fromRow);
                const dc = Math.sign(toCol - fromCol);
                const dist = Math.max(Math.abs(toRow - fromRow), Math.abs(toCol - fromCol));
                
                for (let i = 1; i < dist; i++) {
                    const checkRow = fromRow + dr * i;
                    const checkCol = fromCol + dc * i;
                    if (this.board[checkRow][checkCol]) {
                        return false;
                    }
                }
                return true;
            }

            // Èßí„ÇíÊâì„Å¶„Çã„Åã
            canDrop(piece, row, col) {
                // ‰∫åÊ≠©„ÉÅ„Çß„ÉÉ„ÇØ
                if (piece === 'Ê≠©') {
                    for (let r = 0; r < 9; r++) {
                        if (this.board[r][col] && 
                            this.board[r][col].piece === 'Ê≠©' && 
                            this.board[r][col].side === 'sente') {
                            return false;
                        }
                    }
                }
                
                // Ë°å„ÅçÊâÄ„ÉÅ„Çß„ÉÉ„ÇØ
                if ((piece === 'Ê≠©' || piece === 'È¶ô') && row === 0) return false;
                if (piece === 'Ê°Ç' && row <= 1) return false;
                
                return true;
            }

            // ÂæåÊâã„ÅåÈßí„ÇíÊâì„Å¶„Çã„Åã
            canDropGote(piece, row, col) {
                // ‰∫åÊ≠©„ÉÅ„Çß„ÉÉ„ÇØ
                if (piece === 'Ê≠©') {
                    for (let r = 0; r < 9; r++) {
                        if (this.board[r][col] && 
                            this.board[r][col].piece === 'Ê≠©' && 
                            this.board[r][col].side === 'gote') {
                            return false;
                        }
                    }
                }
                
                // Ë°å„ÅçÊâÄ„ÉÅ„Çß„ÉÉ„ÇØÔºàÂæåÊâã„Å™„ÅÆ„ÅßÈÄÜÊñπÂêëÔºâ
                if ((piece === 'Ê≠©' || piece === 'È¶ô') && row === 8) return false;
                if (piece === 'Ê°Ç' && row >= 7) return false;
                
                return true;
            }

            // ÂæåÊâã„Åå„Åì„ÅÆÈßí„ÇíÊåÅÈßí„Å®„Åó„Å¶‰Ωø„Åà„Çã„Åã
            canGoteUsePiece(piece) {
                // Ë©∞Â∞ÜÊ£ã„Åß„ÅØÂÖàÊâã„ÅÆÊåÅÈßí‰ª•Â§ñ„ÅØÂÖ®„Å¶ÂæåÊâã„ÅåÊåÅ„Å£„Å¶„ÅÑ„Çã
                // „Åü„Å†„Åó„ÄÅÁõ§‰∏ä„Å´„ÅÇ„ÇãÈßí„ÅÆÊï∞„ÇíËÄÉÊÖÆ„Åô„ÇãÂøÖË¶Å„Åå„ÅÇ„Çã
                
                // ÂêÑÈßí„ÅÆÊúÄÂ§ßÊûöÊï∞
                const maxPieces = {
                    'È£õ': 2, 'Ëßí': 2, 'Èáë': 4, 'ÈäÄ': 4,
                    'Ê°Ç': 4, 'È¶ô': 4, 'Ê≠©': 18
                };
                
                // Áõ§‰∏ä„Å´„ÅÇ„ÇãÈßí„ÇíÊï∞„Åà„Çã
                let boardCount = 0;
                let senteHandCount = this.mochiGoma.sente[piece] || 0;
                
                for (let row = 0; row < 9; row++) {
                    for (let col = 0; col < 9; col++) {
                        const p = this.board[row][col];
                        if (p) {
                            // ÊàêÈßí„ÇíÂÖÉ„ÅÆÈßí„Å´Êàª„Åó„Å¶Êï∞„Åà„Çã
                            const demoted = this.demotePiece(p.piece);
                            if (demoted === piece) {
                                boardCount++;
                            }
                        }
                    }
                }
                
                // ÂæåÊâã„Åå‰Ωø„Åà„ÇãÈßíÊï∞ = ÊúÄÂ§ßÊï∞ - Áõ§‰∏ä„ÅÆÊï∞ - ÂÖàÊâã„ÅÆÊåÅÈßíÊï∞
                const available = maxPieces[piece] - boardCount - senteHandCount;
                
                if (this.debugMode && available > 0) {
                    this.debugLog(`      ÂæåÊâã„ÅØ${piece}„ÇíÊåÅÈßí„Å®„Åó„Å¶‰Ωø„Åà„Çã (ÊúÄÂ§ß:${maxPieces[piece]} Áõ§‰∏ä:${boardCount} ÂÖàÊâãÊåÅ:${senteHandCount} ‚Üí ‰ΩøÁî®ÂèØËÉΩ:${available})`);
                }
                
                return available > 0;
            }

            // ÂêàÈßí„ÅåÊúâÂäπ„Åã„Å©„ÅÜ„ÅãÂà§ÂÆö
            isValidAigoma(piece, row, col, attackers) {
                // ÊîªÊíÉËÄÖ„Åå0„Å™„ÇâÂêàÈßí„ÅÆÂøÖË¶Å„Å™„Åó
                if (attackers.length === 0) return false;
                
                // ÊîªÊíÉËÄÖ„Åå2„Å§‰ª•‰∏ä„Å™„Çâ‰∏°Âäπ„Åç„ÅßÂêàÈßíÁÑ°Âäπ
                if (attackers.length >= 2) return false;
                
                // 1„Å§„ÅÆÊîªÊíÉËÄÖ„ÅÆÂ†¥Âêà„ÄÅÂêàÈßí„ÇíË©¶„Åó„Å¶„Åø„Çã
                const testMove = {
                    type: 'drop',
                    piece: piece,
                    to: internalToHuman(row, col),
                    side: 'gote'
                };
                
                // ÂêàÈßí„ÇíÂÆüË°å
                const backup = this.makeMove(testMove);
                
                // ÂêàÈßíÂæå„ÇÇÁéãÊâã„ÅåÁ∂ö„Åè„ÅãÁ¢∫Ë™ç
                const stillInCheck = this.isCheck('gote');
                
                // ÂêàÈßí„ÇíÊàª„Åô
                this.unmakeMove(testMove, backup);
                
                // ÂêàÈßíÂæå„Å´ÁéãÊâã„ÅåËß£Èô§„Åï„Çå„Çå„Å∞ÊúâÂäπ
                return !stillInCheck;
            }

            // Êàê„ÇäÂà§ÂÆö
            canPromote(piece, fromRow, toRow, side) {
                if (piece === 'Èáë' || piece === 'Áéâ' || 
                    piece === '„Å®' || piece === 'Êùè' || piece === 'Âú≠' || 
                    piece === 'ÂÖ®' || piece === 'È¶¨' || piece === 'Èæç') {
                    return false;
                }
                
                if (side === 'sente') {
                    return fromRow <= 2 || toRow <= 2;
                } else {
                    return fromRow >= 6 || toRow >= 6;
                }
            }
            
            // ÂøÖ„ÅöÊàê„Çâ„Å™„Åë„Çå„Å∞„Å™„Çâ„Å™„ÅÑ„ÅãÂà§ÂÆö
            mustPromote(piece, fromRow, toRow, side) {
                if (side === 'sente') {
                    // Ê≠©„ÉªÈ¶ôËªä„ÅØÔºëÊÆµÁõÆ„ÄÅÊ°ÇÈ¶¨„ÅØÔºë„ÉªÔºíÊÆµÁõÆ„ÅßÂøÖ„ÅöÊàê„Çã
                    if ((piece === 'Ê≠©' || piece === 'È¶ô') && toRow === 0) return true;
                    if (piece === 'Ê°Ç' && toRow <= 1) return true;
                } else {
                    // Ê≠©„ÉªÈ¶ôËªä„ÅØÔºôÊÆµÁõÆ„ÄÅÊ°ÇÈ¶¨„ÅØÔºò„ÉªÔºôÊÆµÁõÆ„ÅßÂøÖ„ÅöÊàê„Çã
                    if ((piece === 'Ê≠©' || piece === 'È¶ô') && toRow === 8) return true;
                    if (piece === 'Ê°Ç' && toRow >= 7) return true;
                }
                return false;
            }

            // Èßí„ÇíÊàê„Çã
            promotePiece(piece) {
                const promoteMap = {
                    'Ê≠©': '„Å®', 'È¶ô': 'Êùè', 'Ê°Ç': 'Âú≠', 'ÈäÄ': 'ÂÖ®',
                    'Ëßí': 'È¶¨', 'È£õ': 'Èæç'
                };
                return promoteMap[piece] || piece;
            }

            // Èßí„ÇíÊàª„Åô
            demotePiece(piece) {
                const demoteMap = {
                    '„Å®': 'Ê≠©', 'Êùè': 'È¶ô', 'Âú≠': 'Ê°Ç', 'ÂÖ®': 'ÈäÄ',
                    'È¶¨': 'Ëßí', 'Èæç': 'È£õ'
                };
                return demoteMap[piece] || piece;
            }

            // Êâã„ÅÆË°®Á§∫
            formatMove(move) {
                const sideSymbol = move.side === 'gote' ? '‚ñ≥' : '‚ñ≤';
                
                if (move.type === 'drop') {
                    return `${sideSymbol}${move.to}${move.piece}Êâì`;
                } else {
                    const capture = move.captured ? '√ó' : '';
                    
                    // ÂÖÉ„ÅÆÈßíÁ®Æ„ÇíÂà§ÂÆöÔºàÊàêÈßí„ÅÆÂ†¥Âêà„ÅØÂÖÉ„Å´Êàª„ÅôÔºâ
                    let originalPiece = move.piece;
                    if (['Èæç', 'È¶¨', '„Å®', 'Êùè', 'Âú≠', 'ÂÖ®'].includes(move.piece)) {
                        originalPiece = this.demotePiece(move.piece);
                    }
                    
                    // Êàê„ÇãÂ†¥Âêà„ÅØÂÖÉ„ÅÆÈßíÂêç+Êàê„ÄÅÊàê„Çâ„Å™„ÅÑÂ†¥Âêà„ÅØÈßíÂêç„ÅÆ„Åø
                    if (move.promote) {
                        return `${sideSymbol}${move.to}${originalPiece}Êàê${capture}(${move.from})`;
                    } else {
                        return `${sideSymbol}${move.to}${move.piece}${capture}(${move.from})`;
                    }
                }
            }

            // „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£
            isInBoard(row, col) {
                return row >= 0 && row < 9 && col >= 0 && col < 9;
            }

            // Áõ§Èù¢„ÅÆÂ¶•ÂΩìÊÄß„ÉÅ„Çß„ÉÉ„ÇØ
            validateBoard() {
                try {
                    let senteKingCount = 0;
                    let goteKingCount = 0;
                    const pieceCounts = {};
                    const pawnColumns = { sente: new Set(), gote: new Set() };
                    
                    // Áõ§‰∏ä„ÅÆÈßí„Çí„Ç´„Ç¶„É≥„Éà
                    for (let row = 0; row < 9; row++) {
                        for (let col = 0; col < 9; col++) {
                            const piece = this.board[row][col];
                            if (!piece) continue;
                            
                            // Áéâ„ÅÆ„Ç´„Ç¶„É≥„Éà
                            if (piece.piece === 'Áéâ') {
                                if (piece.side === 'sente') senteKingCount++;
                                else goteKingCount++;
                            }
                            
                            // ÈßíÁ®ÆÂà•„Ç´„Ç¶„É≥„Éà
                            const demoted = this.demotePiece(piece.piece);
                            const key = `${demoted}_${piece.side}`;
                            pieceCounts[key] = (pieceCounts[key] || 0) + 1;
                            
                            // ‰∫åÊ≠©„ÉÅ„Çß„ÉÉ„ÇØÁî®
                            if (piece.piece === 'Ê≠©') {
                                if (pawnColumns[piece.side].has(col)) {
                                    return { valid: false, message: `${piece.side === 'sente' ? 'ÂÖàÊâã' : 'ÂæåÊâã'}„ÅÆ‰∫åÊ≠©„Åå„ÅÇ„Çä„Åæ„ÅôÔºà${col + 1}Á≠ãÔºâ` };
                                }
                                pawnColumns[piece.side].add(col);
                            }
                            
                            // Ë°å„ÅçÊâÄ„ÅÆ„Å™„ÅÑÈßí„ÉÅ„Çß„ÉÉ„ÇØ
                            if (piece.side === 'sente') {
                                if ((piece.piece === 'Ê≠©' || piece.piece === 'È¶ô') && row === 0) {
                                    return { valid: false, message: `Ë°å„ÅçÊâÄ„ÅÆ„Å™„ÅÑ${piece.piece}„Åå„ÅÇ„Çä„Åæ„ÅôÔºà${internalToHuman(row, col)}Ôºâ` };
                                }
                                if (piece.piece === 'Ê°Ç' && row <= 1) {
                                    return { valid: false, message: `Ë°å„ÅçÊâÄ„ÅÆ„Å™„ÅÑÊ°Ç„Åå„ÅÇ„Çä„Åæ„ÅôÔºà${internalToHuman(row, col)}Ôºâ` };
                                }
                            } else {
                                if ((piece.piece === 'Ê≠©' || piece.piece === 'È¶ô') && row === 8) {
                                    return { valid: false, message: `Ë°å„ÅçÊâÄ„ÅÆ„Å™„ÅÑ${piece.piece}„Åå„ÅÇ„Çä„Åæ„ÅôÔºà${internalToHuman(row, col)}Ôºâ` };
                                }
                                if (piece.piece === 'Ê°Ç' && row >= 7) {
                                    return { valid: false, message: `Ë°å„ÅçÊâÄ„ÅÆ„Å™„ÅÑÊ°Ç„Åå„ÅÇ„Çä„Åæ„ÅôÔºà${internalToHuman(row, col)}Ôºâ` };
                                }
                            }
                        }
                    }
                    
                    // Áéâ„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ
                    if (senteKingCount > 1) {
                        return { valid: false, message: 'ÂÖàÊâã„ÅÆÁéâ„ÅåË§áÊï∞„ÅÇ„Çä„Åæ„Åô' };
                    }
                    if (goteKingCount === 0) {
                        return { valid: false, message: 'ÂæåÊâã„ÅÆÁéâ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì' };
                    }
                    if (goteKingCount > 1) {
                        return { valid: false, message: 'ÂæåÊâã„ÅÆÁéâ„ÅåË§áÊï∞„ÅÇ„Çä„Åæ„Åô' };
                    }
                    
                    // ÈßíÊï∞„ÅÆ‰∏äÈôê„ÉÅ„Çß„ÉÉ„ÇØ
                    const maxPieces = {
                        'È£õ': 2, 'Ëßí': 2, 'Èáë': 4, 'ÈäÄ': 4,
                        'Ê°Ç': 4, 'È¶ô': 4, 'Ê≠©': 18
                    };
                    
                    for (const [piece, maxCount] of Object.entries(maxPieces)) {
                        const totalCount = (pieceCounts[`${piece}_sente`] || 0) + 
                                         (pieceCounts[`${piece}_gote`] || 0) +
                                         (this.mochiGoma.sente[piece] || 0);
                        
                        if (totalCount > maxCount) {
                            return { valid: false, message: `${piece}„ÅÆÊï∞„ÅåÂ§ö„Åô„Åé„Åæ„ÅôÔºà${totalCount}Êûö / ÊúÄÂ§ß${maxCount}ÊûöÔºâ` };
                        }
                    }
                    
                    // ÂÖàÊâãÁéâ„ÅåÁéãÊâã„Åï„Çå„Å¶„ÅÑ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØÔºàË©∞Â∞ÜÊ£ã„Åß„ÅØÂÖàÊâãÁéâ„ÅØÁéãÊâã„Åï„Çå„Å¶„ÅÑ„Å¶„ÅØ„ÅÑ„Åë„Å™„ÅÑÔºâ
                    if (senteKingCount === 1 && this.isCheck('sente')) {
                        return { valid: false, message: 'ÂÖàÊâãÁéâ„ÅåÁéãÊâã„Åï„Çå„Å¶„ÅÑ„Åæ„ÅôÔºàË©∞Â∞ÜÊ£ã„Åß„ÅØÁÑ°ÂäπÔºâ' };
                    }
                    
                    return { valid: true };
                    
                } catch (error) {
                    console.error('Áõ§Èù¢Ê§úË®º„Ç®„É©„Éº:', error);
                    return { valid: false, message: ' Áõ§Èù¢„ÅÆÊ§úË®º‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü' };
                }
            }

            // Êâã„ÅÆ‰∏¶„Å≥Êõø„ÅàÔºàËâØ„ÅÑÊâã„ÇíÂÑ™ÂÖàÔºâ
            orderMoves(moves, depth) {
                // ÂêÑÊâã„Å´„Çπ„Ç≥„Ç¢„Çí‰ªò„Åë„Çã
                const scoredMoves = moves.map(move => {
                    let score = 0;
                    
                    // „Ç≠„É©„Éº„É†„Éº„Éñ„Éú„Éº„Éä„Çπ
                    const killerKey = `${depth}_${this.formatMove(move)}`;
                    if (this.killerMoves.has(killerKey)) {
                        score += 1000;
                    }
                    
                    // Èßí„ÇíÂèñ„ÇãÊâã„ÇíÂÑ™ÂÖà
                    if (move.captured) {
                        score += 500;
                        // ‰æ°ÂÄ§„ÅÆÈ´ò„ÅÑÈßí„ÇíÂèñ„ÇãÊâã„Çí„Åï„Çâ„Å´ÂÑ™ÂÖà
                        const pieceValues = {
                            'È£õ': 100, 'Èæç': 110, 'Ëßí': 90, 'È¶¨': 95,
                            'Èáë': 60, 'ÈäÄ': 50, 'Ê°Ç': 40, 'È¶ô': 30, 'Ê≠©': 10
                        };
                        score += pieceValues[move.captured.piece] || 0;
                    }
                    
                    // ÈßíÊâì„Å°„Çà„ÇäÁßªÂãï„ÇíÂÑ™ÂÖàÔºà‰∏ÄËà¨ÁöÑ„Å´ÁßªÂãï„ÅÆÊñπ„ÅåÂº∑„ÅÑÔºâ
                    if (move.type === 'move') {
                        score += 20;
                    }
                    
                    // Êàê„ÇãÊâã„ÇíÂÑ™ÂÖà
                    if (move.promote) {
                        score += 30;
                    }
                    
                    // „Éí„Çπ„Éà„É™„Éº„ÉÜ„Éº„Éñ„É´„ÅÆ„Çπ„Ç≥„Ç¢
                    const histKey = this.formatMove(move);
                    if (this.historyTable.has(histKey)) {
                        score += this.historyTable.get(histKey);
                    }
                    
                    return { move, score };
                });
                
                // „Çπ„Ç≥„Ç¢„ÅÆÈ´ò„ÅÑÈ†Ü„Å´„ÇΩ„Éº„Éà
                scoredMoves.sort((a, b) => b.score - a.score);
                
                return scoredMoves.map(sm => sm.move);
            }

            // „Ç≠„É©„Éº„É†„Éº„Éñ„ÇíË®òÈå≤
            recordKillerMove(depth, move) {
                const key = `${depth}_${this.formatMove(move)}`;
                this.killerMoves.set(key, true);
                
                // Âè§„ÅÑ„Ç≠„É©„Éº„É†„Éº„Éñ„ÇíÂâäÈô§Ôºà„É°„É¢„É™ÁØÄÁ¥ÑÔºâ
                if (this.killerMoves.size > 1000) {
                    const firstKey = this.killerMoves.keys().next().value;
                    this.killerMoves.delete(firstKey);
                }
            }

            displayMoves(moves) {
                const moveList = document.getElementById('moveList');
                moveList.style.display = 'block';
                moveList.innerHTML = '<h3>Ë©∞„ÅøÊâãÈ†Ü</h3>';
                
                moves.forEach((move, index) => {
                    const moveItem = document.createElement('div');
                    moveItem.className = 'move-item';
                    moveItem.textContent = `${index + 1}. ${move}`;
                    moveList.appendChild(moveItem);
                });
            }

            updateStatus(message, type = '') {
                const status = document.getElementById('status');
                status.textContent = message;
                status.className = 'status ' + type;
            }

            clearBoard() {
                this.board = Array(9).fill(null).map(() => Array(9).fill(null));
                this.mochiGoma = { sente: {}, gote: {} };
                this.updateBoard();
                this.updateMochiGomaDisplay();
                this.updateStatus('Áõ§Èù¢„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„Åü');
                document.getElementById('moveList').style.display = 'none';
                document.getElementById('stats').innerHTML = '';
            }
            
            updateMochiGomaDisplay() {
                const senteMochi = document.getElementById('senteMochi');
                
                const formatMochi = (mochi) => {
                    if (Object.keys(mochi).length === 0) return '„Å™„Åó';
                    return Object.entries(mochi)
                        .map(([piece, count]) => `${piece}${count > 1 ? count : ''}`)
                        .join(' ');
                };
                
                senteMochi.textContent = formatMochi(this.mochiGoma.sente);
            }

            getProblemList() {
                return [
                    {
                        name: '1ÊâãË©∞„ÇÅÔºàÂü∫Êú¨Ôºâ',
                        position: '‚ñ≥Ôºï‰∏ÄÁéâ ‚ñ≤Ôºñ‰∫åÈáë ‚ñ≤Ôºï‰∫åÈáë',
                        description: '‚ñ≤Ôºî‰∫åÈáë„ÅßË©∞„Åø'
                    },
                    {
                        name: '3ÊâãË©∞„ÇÅÔºàÊåÅÈßí‰ΩøÁî®Ôºâ',
                        position: '‚ñ≥Ôºï‰∫åÁéâ ‚ñ≥Ôºî‰∫åÊ≠© ‚ñ≤Ôºï‰∫îÈ£õ ‚ñ≤ÊåÅÈáë1',
                        description: '‚ñ≤Ôºï‰∏âÈáëÊâì„Åã„ÇâË©∞„Åø'
                    },
                    {
                        name: '3ÊâãË©∞„ÇÅÔºàÂêàÈßíÂïèÈ°åÔºâ',
                        position: '‚ñ≥Ôºî‰∏ÄÁéâ ‚ñ≥Ôºî‰∫åÊ≠© ‚ñ≤Ôºí‰∫åÈ£õ ‚ñ≤Ôºï‰∏âÊ≠© ‚ñ≤ÊåÅÈäÄ1',
                        description: '‚ñ≤Ôºí‰∏ÄÈ£õÊàê‚Üí‚ñ≥Ôºì‰∏ÄÊ≠©Âêà‚Üí‚ñ≤Ôºï‰∫åÈäÄÊâì„ÅßË©∞„Åø'
                    },
                    {
                        name: '‰∏çË©∞„ÅøÔºàÂêàÈßí„ÅßÈÄÉ„Çå„ÇãÔºâ',
                        position: '‚ñ≥Ôºí‰∫åÁéâ ‚ñ≥Ôºí‰∏ÄÈäÄ ‚ñ≥Ôºí‰∏âÊ≠© ‚ñ≥Ôºë‰∏âÊ≠© ‚ñ≤ÔºîÂõõÈæç ‚ñ≤Ôºï‰∫îËßí',
                        description: 'ÂêàÈßí„ÅßÈÄÉ„Çå„Å¶‰∏çË©∞„Åø'
                    },
                    {
                        name: '1ÊâãË©∞„ÇÅÔºàÈ†≠ÈáëÔºâ',
                        position: '‚ñ≥Ôºë‰∫åÁéâ ‚ñ≥Ôºë‰∏âÊ≠© ‚ñ≤Ôºí‰∫åÈáë ‚ñ≤ÔºíÂõõÊ≠©',
                        description: '‚ñ≤Ôºë‰∏âÈáë„ÅßË©∞„Åø'
                    },
                    {
                        name: '3ÊâãË©∞„ÇÅÔºàÈ£õËªä„ÅÆÂà©„ÅçÔºâ',
                        position: '‚ñ≥Ôºë‰∏ÄÁéâ ‚ñ≥Ôºí‰∏ÄÈáë ‚ñ≤Ôºë‰∏âÈ£õ ‚ñ≤ÊåÅÈáë1',
                        description: '‚ñ≤Ôºí‰∫åÈáëÊâì„Åã„ÇâË©∞„Åø'
                    }
                ];
            }
            
            loadSampleProblem() {
                const problems = this.getProblemList();
                
                // „É©„É≥„ÉÄ„É†„Å´ÈÅ∏Êäû
                const problem = problems[Math.floor(Math.random() * problems.length)];
                
                this.clearBoard();
                this.decodePosition(problem.position);
                this.updateBoard();
                this.updateMochiGomaDisplay();
                this.updateStatus(`‰æãÈ°å„Äå${problem.name}„Äç„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü - ${problem.description}`);
            }
            
            loadSpecificProblem(index) {
                const problems = this.getProblemList();
                
                if (index >= 0 && index < problems.length) {
                    const problem = problems[index];
                    
                    this.clearBoard();
                    this.decodePosition(problem.position);
                    this.updateBoard();
                    this.updateMochiGomaDisplay();
                    this.updateStatus(`‰æãÈ°å„Äå${problem.name}„Äç„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü - ${problem.description}`);
                } else {
                    this.updateStatus('ÁÑ°Âäπ„Å™‰æãÈ°åÁï™Âè∑„Åß„Åô', 'error');
                }
            }

            // ÈÖçÁΩÆ„ÇíÊñáÂ≠óÂàó„Å´„Ç®„É≥„Ç≥„Éº„Éâ
            encodePosition() {
                const pieces = [];
                
                // Áõ§‰∏ä„ÅÆÈßí
                for (let row = 0; row < 9; row++) {
                    for (let col = 0; col < 9; col++) {
                        const piece = this.board[row][col];
                        if (piece) {
                            const pos = internalToHuman(row, col);
                            const prefix = piece.side === 'gote' ? '‚ñ≥' : '‚ñ≤';
                            pieces.push(`${prefix}${pos}${piece.piece}`);
                        }
                    }
                }
                
                // ÊåÅ„Å°Èßí
                for (const [piece, count] of Object.entries(this.mochiGoma.sente)) {
                    if (count > 0) {
                        pieces.push(`‚ñ≤ÊåÅ${piece}${count > 1 ? count : ''}`);
                    }
                }
                
                return pieces.join(' ');
            }

            // ÊñáÂ≠óÂàó„Åã„ÇâÈÖçÁΩÆ„Çí„Éá„Ç≥„Éº„Éâ
            decodePosition(code) {
                console.log('„Éá„Ç≥„Éº„ÉâÈñãÂßã:', code);
                this.clearBoard();
                
                // „Çπ„Éö„Éº„Çπ„Åæ„Åü„ÅØ„Ç´„É≥„Éû„ÅßÂàÜÂâ≤
                const parts = code.trim().split(/[\s,]+/);
                console.log('ÂàÜÂâ≤„Åï„Çå„Åü„Éë„Éº„ÉÑ:', parts);
                
                for (const part of parts) {
                    if (part.length < 3) {
                        console.log('„Çπ„Ç≠„ÉÉ„ÉóÔºàÁü≠„Åô„Åé„ÇãÔºâ:', part);
                        continue;
                    }
                    
                    const prefix = part[0];
                    const side = prefix === '‚ñ≥' ? 'gote' : 'sente';
                    
                    if (part.includes('ÊåÅ')) {
                        // ÊåÅ„Å°Èßí
                        const match = part.match(/ÊåÅ(.+?)(\d*)$/);
                        if (match) {
                            const piece = match[1];
                            const count = match[2] ? parseInt(match[2]) : 1;
                            console.log(`ÊåÅ„Å°Èßí: ${piece} x ${count}`);
                            this.mochiGoma.sente[piece] = count;
                        }
                    } else {
                        // Áõ§‰∏ä„ÅÆÈßí
                        const pos = part.substring(1, 3);
                        const piece = part.substring(3);
                        console.log(`Áõ§‰∏ä: ${pos} „Å´ ${side} „ÅÆ ${piece}`);
                        
                        const coords = humanToInternal(pos);
                        if (coords) {
                            const [row, col] = coords;
                            this.board[row][col] = { piece, side };
                        } else {
                            console.error('Â∫ßÊ®ôÂ§âÊèõÂ§±Êïó:', pos);
                        }
                    }
                }
                
                this.updateBoard();
                this.updateMochiGomaDisplay();
                console.log('„Éá„Ç≥„Éº„ÉâÂÆå‰∫Ü');
            }

            // ÈÖçÁΩÆ„Çí‰øùÂ≠ò
            saveToLocalStorage(name) {
                const saved = this.getSavedPositions();
                saved[name] = {
                    code: this.encodePosition(),
                    date: new Date().toLocaleString('ja-JP')
                };
                localStorage.setItem('tsumePositions', JSON.stringify(saved));
            }

            // ‰øùÂ≠ò„Åó„ÅüÈÖçÁΩÆ„ÇíÂèñÂæó
            getSavedPositions() {
                const saved = localStorage.getItem('tsumePositions');
                return saved ? JSON.parse(saved) : {};
            }

            // ÈÖçÁΩÆ„ÇíÂâäÈô§
            deleteFromLocalStorage(name) {
                const saved = this.getSavedPositions();
                delete saved[name];
                localStorage.setItem('tsumePositions', JSON.stringify(saved));
            }
        }

        // „Ç®„É≥„Ç∏„É≥ÂàùÊúüÂåñ
        const engine = new TsumeShogi();

        // „Ç∞„É≠„Éº„Éê„É´Èñ¢Êï∞
        function solveTsume() {
            engine.solveTsume();
        }

        function clearBoard() {
            engine.clearBoard();
        }

        function loadSampleProblem() {
            engine.loadSampleProblem();
        }
        
        function loadSpecificProblem() {
            const select = document.getElementById('problemSelect');
            const index = parseInt(select.value);
            if (!isNaN(index)) {
                engine.loadSpecificProblem(index);
            } else {
                engine.updateStatus('‰æãÈ°å„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
            }
        }
        
        function addMochiGoma() {
            const select = document.getElementById('mochiPiece');
            const piece = select.value;
            if (!piece) return;
            
            if (!engine.mochiGoma.sente[piece]) {
                engine.mochiGoma.sente[piece] = 0;
            }
            engine.mochiGoma.sente[piece]++;
            engine.updateMochiGomaDisplay();
            select.value = '';
        }
        
        function clearSenteMochi() {
            engine.mochiGoma.sente = {};
            engine.updateMochiGomaDisplay();
        }

        // ÈÖçÁΩÆ„ÅÆ‰øùÂ≠ò„ÉªË™≠ËæºÊ©üËÉΩ
        function savePosition() {
            const name = prompt('ÈÖçÁΩÆ„ÅÆÂêçÂâç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö');
            if (name && name.trim()) {
                engine.saveToLocalStorage(name.trim());
                engine.updateStatus(`„Äå${name}„Äç„Å®„Åó„Å¶‰øùÂ≠ò„Åó„Åæ„Åó„Åü`);
                updatePositionSelect();
            }
        }

        function showSavedPositions() {
            const div = document.getElementById('savedPositions');
            div.style.display = div.style.display === 'none' ? 'block' : 'none';
            if (div.style.display === 'block') {
                updatePositionSelect();
            }
        }

        function updatePositionSelect() {
            const select = document.getElementById('positionSelect');
            const saved = engine.getSavedPositions();
            
            select.innerHTML = '<option value="">‰øùÂ≠ò„Åó„ÅüÈÖçÁΩÆ„ÇíÈÅ∏Êäû</option>';
            
            for (const [name, data] of Object.entries(saved)) {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = `${name} (${data.date})`;
                select.appendChild(option);
            }
        }

        function loadPosition() {
            const select = document.getElementById('positionSelect');
            const name = select.value;
            if (!name) {
                engine.updateStatus('ÈÖçÁΩÆ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                return;
            }
            
            const saved = engine.getSavedPositions();
            console.log('‰øùÂ≠ò„Åï„Çå„ÅüÈÖçÁΩÆ‰∏ÄË¶ß:', saved);
            console.log('ÈÅ∏Êäû„Åï„Çå„ÅüÈÖçÁΩÆÂêç:', name);
            
            if (saved[name]) {
                console.log('Ë™≠„ÅøËæº„ÇÄÈÖçÁΩÆ„Ç≥„Éº„Éâ:', saved[name].code);
                try {
                    engine.decodePosition(saved[name].code);
                    engine.updateStatus(`„Äå${name}„Äç„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü`);
                } catch (error) {
                    console.error('ÈÖçÁΩÆË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
                    engine.updateStatus('ÈÖçÁΩÆ„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
                }
            } else {
                engine.updateStatus('ÊåáÂÆö„Åï„Çå„ÅüÈÖçÁΩÆ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì', 'error');
            }
        }

        function deletePosition() {
            const select = document.getElementById('positionSelect');
            const name = select.value;
            if (!name) return;
            
            if (confirm(`„Äå${name}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) {
                engine.deleteFromLocalStorage(name);
                updatePositionSelect();
                engine.updateStatus(`„Äå${name}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü`);
            }
        }

        function exportPosition() {
            const code = engine.encodePosition();
            const textarea = document.getElementById('positionCode');
            textarea.value = code;
            
            // „ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº
            textarea.select();
            document.execCommand('copy');
            
            engine.updateStatus('ÈÖçÁΩÆ„Ç≥„Éº„Éâ„Çí„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü');
        }

        function importPosition() {
            const textarea = document.getElementById('positionCode');
            const code = textarea.value.trim();
            
            if (code) {
                try {
                    engine.decodePosition(code);
                    engine.updateStatus('ÈÖçÁΩÆ„Ç≥„Éº„Éâ„Åã„ÇâË™≠„ÅøËæº„Åø„Åæ„Åó„Åü');
                } catch (error) {
                    console.error('ÈÖçÁΩÆË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
                    engine.updateStatus('ÈÖçÁΩÆ„Ç≥„Éº„Éâ„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì', 'error');
                }
            }
        }

        function toggleDebugMode() {
            const checkbox = document.getElementById('debugMode');
            const debugOutput = document.getElementById('debugOutput');
            engine.debugMode = checkbox.checked;
            debugOutput.style.display = checkbox.checked ? 'block' : 'none';
            
            if (checkbox.checked) {
                engine.updateStatus('„Éá„Éê„ÉÉ„Ç∞„É¢„Éº„ÉâÊúâÂäπ');
            } else {
                engine.updateStatus('„Éá„Éê„ÉÉ„Ç∞„É¢„Éº„ÉâÁÑ°Âäπ');
                debugOutput.innerHTML = '';
            }
        }

        // „Éá„Éê„ÉÉ„Ç∞Âá∫Âäõ„Çí„Ç®„É≥„Ç∏„É≥„Å´ËøΩÂä†
        engine.debugLog = function(message) {
            if (this.debugMode) {
                const debugOutput = document.getElementById('debugOutput');
                const timestamp = new Date().toLocaleTimeString('ja-JP', { 
                    hour12: false, 
                    hour: '2-digit', 
                    minute: '2-digit', 
                    second: '2-digit'
                });
                debugOutput.innerHTML += `[${timestamp}] ${message}<br>`;
                debugOutput.scrollTop = debugOutput.scrollHeight;
                
                // „Ç≥„É≥„ÇΩ„Éº„É´„Å´„ÇÇÂá∫Âäõ
                console.log(`[DEBUG] ${message}`);
            }
        };
        
        // Áõ§Èù¢„ÅÆ„Éá„Éê„ÉÉ„Ç∞Âá∫Âäõ
        engine.debugBoard = function() {
            if (!this.debugMode) return;
            
            let boardStr = '\n';
            boardStr += '  Ôºô Ôºò Ôºó Ôºñ Ôºï Ôºî Ôºì Ôºí Ôºë\n';
            boardStr += '+--+--+--+--+--+--+--+--+--+\n';
            
            for (let row = 0; row < 9; row++) {
                boardStr += DAN_STR[row] + '|';
                for (let col = 0; col < 9; col++) {
                    const piece = this.board[row][col];
                    if (piece) {
                        const prefix = piece.side === 'gote' ? '‚ñ≥' : '‚ñ≤';
                        boardStr += prefix + piece.piece;
                    } else {
                        boardStr += '  ';
                    }
                    boardStr += '|';
                }
                boardStr += '\n';
            }
            boardStr += '+--+--+--+--+--+--+--+--+--+\n';
            
            // ÊåÅ„Å°Èßí
            const formatMochi = (mochi) => {
                if (Object.keys(mochi).length === 0) return '„Å™„Åó';
                return Object.entries(mochi)
                    .map(([piece, count]) => `${piece}${count > 1 ? count : ''}`)
                    .join(' ');
            };
            boardStr += `ÂÖàÊâãÊåÅÈßí: ${formatMochi(this.mochiGoma.sente)}\n`;
            
            this.debugLog(boardStr);
        };
    </script>
</body>
</html>